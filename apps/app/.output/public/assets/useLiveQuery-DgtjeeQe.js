import{g as Bs,r as j}from"./main-DJAnHGiT.js";function ue(n,e){return Ue(n,e,new Map)}function Ue(n,e,t){if(n===e)return!0;if(n==null||e==null||typeof n!=typeof e)return!1;if(n instanceof Date)return e instanceof Date?n.getTime()===e.getTime():!1;if(n instanceof RegExp)return e instanceof RegExp?n.source===e.source&&n.flags===e.flags:!1;if(n instanceof Map){if(!(e instanceof Map)||n.size!==e.size)return!1;if(t.has(n))return t.get(n)===e;t.set(n,e);const r=Array.from(n.entries()).every(([i,o])=>e.has(i)&&Ue(o,e.get(i),t));return t.delete(n),r}if(n instanceof Set){if(!(e instanceof Set)||n.size!==e.size)return!1;if(t.has(n))return t.get(n)===e;t.set(n,e);const s=Array.from(n),r=Array.from(e);if(s.every(o=>typeof o!="object"))return t.delete(n),s.every(o=>e.has(o));const i=s.length===r.length;return t.delete(n),i}if(ArrayBuffer.isView(n)&&ArrayBuffer.isView(e)&&!(n instanceof DataView)&&!(e instanceof DataView)){const s=n,r=e;if(s.length!==r.length)return!1;for(let i=0;i<s.length;i++)if(s[i]!==r[i])return!1;return!0}if(ot(n)&&ot(e)){const s=Pt(n),r=Pt(e);return s!==r?!1:typeof n.equals=="function"?n.equals(e):n.toString()===e.toString()}if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;if(t.has(n))return t.get(n)===e;t.set(n,e);const s=n.every((r,i)=>Ue(r,e[i],t));return t.delete(n),s}if(typeof n=="object"){if(t.has(n))return t.get(n)===e;t.set(n,e);const s=Object.keys(n),r=Object.keys(e);if(s.length!==r.length)return t.delete(n),!1;const i=s.every(o=>o in e&&Ue(n[o],e[o],t));return t.delete(n),i}return!1}const Vs=["Temporal.Duration","Temporal.Instant","Temporal.PlainDate","Temporal.PlainDateTime","Temporal.PlainMonthDay","Temporal.PlainTime","Temporal.PlainYearMonth","Temporal.ZonedDateTime"];function Pt(n){return n[Symbol.toStringTag]}function ot(n){const e=Pt(n);return typeof e=="string"&&Vs.includes(e)}var Ls={};function x(...n){const e=typeof window<"u"&&typeof localStorage<"u";e&&localStorage.getItem("DEBUG")==="true"?console.log("[proxy]",...n):!e&&typeof process<"u"&&Ls.DEBUG==="true"&&console.log("[proxy]",...n)}function Y(n,e=new WeakMap){if(n==null||typeof n!="object")return n;if(e.has(n))return e.get(n);if(n instanceof Date)return new Date(n.getTime());if(n instanceof RegExp)return new RegExp(n.source,n.flags);if(Array.isArray(n)){const r=[];return e.set(n,r),n.forEach((i,o)=>{r[o]=Y(i,e)}),r}if(ArrayBuffer.isView(n)&&!(n instanceof DataView)){const r=Object.getPrototypeOf(n).constructor,i=new r(n.length);e.set(n,i);for(let o=0;o<n.length;o++)i[o]=n[o];return i}if(n instanceof Map){const r=new Map;return e.set(n,r),n.forEach((i,o)=>{r.set(o,Y(i,e))}),r}if(n instanceof Set){const r=new Set;return e.set(n,r),n.forEach(i=>{r.add(Y(i,e))}),r}if(ot(n))return n;const t={};e.set(n,t);for(const r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=Y(n[r],e));const s=Object.getOwnPropertySymbols(n);for(const r of s)t[r]=Y(n[r],e);return t}let ln=0;function Us(){return ln+=1,ln}function Ut(n,e){const t=new Map;function s(u,d){if(x("Object ID:",u.constructor.name),t.has(u))return t.get(u);{const f=Ut(u,d);return t.set(u,f),f}}const r=new Map,i={copy_:Y(n),originalObject:Y(n),proxyCount:Us(),modified:!1,assigned_:{},parent:e,target:n};x("createChangeProxy called for target",n,i.proxyCount);function o(u){u.modified||(u.modified=!0),u.parent&&(x("propagating change to parent"),"updateMap"in u.parent?u.parent.updateMap(u.copy_):"updateSet"in u.parent?u.parent.updateSet(u.copy_):(u.parent.tracker.copy_[u.parent.prop]=u.copy_,u.parent.tracker.assigned_[u.parent.prop]=!0),o(u.parent.tracker))}function a(u){if(x("checkIfReverted called with assigned keys:",Object.keys(u.assigned_)),Object.keys(u.assigned_).length===0&&Object.getOwnPropertySymbols(u.assigned_).length===0)return x("No assigned properties, returning true"),!0;for(const f in u.assigned_)if(u.assigned_[f]===!0){const p=u.copy_[f],g=u.originalObject[f];if(x(`Checking property ${String(f)}, current:`,p,"original:",g),!ue(p,g))return x(`Property ${String(f)} is different, returning false`),!1}else if(u.assigned_[f]===!1)return x(`Property ${String(f)} was deleted, returning false`),!1;const d=Object.getOwnPropertySymbols(u.assigned_);for(const f of d)if(u.assigned_[f]===!0){const p=u.copy_[f],g=u.originalObject[f];if(!ue(p,g))return x("Symbol property is different, returning false"),!1}else if(u.assigned_[f]===!1)return x("Symbol property was deleted, returning false"),!1;return x("All properties match original values, returning true"),!0}function c(u,d){x("checkParentStatus called for child prop:",d);const f=a(u);x("Parent checkIfReverted returned:",f),f&&(x("Parent is fully reverted, clearing tracking"),u.modified=!1,u.assigned_={},u.parent&&(x("Continuing up the parent chain"),c(u.parent.tracker,u.parent.prop)))}function l(u){if(x("createObjectProxy",u),r.has(u))return x("proxyCache found match"),r.get(u);const d=new Proxy(u,{get(f,p){x("get",f,p);const g=i.copy_[p]??i.originalObject[p],y=i.originalObject[p];x("value (at top of proxy get)",g);const C=Object.getOwnPropertyDescriptor(f,p);if(C?.get)return g;if(typeof g=="function"){if(Array.isArray(f)){const v=p.toString();if(new Set(["pop","push","shift","unshift","splice","sort","reverse","fill","copyWithin"]).has(v))return function(...S){const m=g.apply(i.copy_,S);return o(i),m}}if(f instanceof Map||f instanceof Set){const v=p.toString();if(new Set(["set","delete","clear","add","pop","push","shift","unshift","splice","sort","reverse"]).has(v))return function(...m){const I=g.apply(i.copy_,m);return o(i),I};if(new Set(["entries","keys","values","forEach",Symbol.iterator]).has(v)||p===Symbol.iterator)return function(...m){const I=g.apply(i.copy_,m);if(v==="forEach"){const P=m[0];if(typeof P=="function"){const K=function(U,w,k){const A=P.call(this,U,w,k);return o(i),A};return g.apply(f,[K,...m.slice(1)])}}if(v==="entries"||v==="values"||v===Symbol.iterator.toString()||p===Symbol.iterator){const P=I,K=new Map;if(v==="values"&&f instanceof Map)for(const[w,k]of i.copy_.entries())K.set(k,w);const U=new Map;if(f instanceof Set)for(const w of i.copy_.values())U.set(w,w);return{next(){const w=P.next();if(!w.done&&w.value&&typeof w.value=="object"){if(v==="entries"&&Array.isArray(w.value)&&w.value.length===2){if(w.value[1]&&typeof w.value[1]=="object"){const k=w.value[0],A={tracker:i,prop:k,updateMap:G=>{i.copy_ instanceof Map&&i.copy_.set(k,G)}},{proxy:W}=s(w.value[1],A);w.value[1]=W}}else if((v==="values"||v===Symbol.iterator.toString()||p===Symbol.iterator)&&typeof w.value=="object"&&w.value!==null)if(v==="values"&&f instanceof Map){const k=K.get(w.value);if(k!==void 0){const A={tracker:i,prop:k,updateMap:G=>{i.copy_ instanceof Map&&i.copy_.set(k,G)}},{proxy:W}=s(w.value,A);w.value=W}}else if(f instanceof Set){const k=w.value,A={tracker:i,prop:k,updateSet:G=>{i.copy_ instanceof Set&&(i.copy_.delete(k),i.copy_.add(G),U.set(k,G))}},{proxy:W}=s(w.value,A);w.value=W}else{const k=Symbol("iterator-value"),{proxy:A}=s(w.value,{tracker:i,prop:k});w.value=A}}return w},[Symbol.iterator](){return this}}}return I}}return g.bind(f)}if(g&&typeof g=="object"&&!(g instanceof Date)&&!(g instanceof RegExp)&&!ot(g)){const v={tracker:i,prop:String(p)},{proxy:E}=s(y,v);return r.set(g,E),E}return g},set(f,p,g){const y=i.copy_[p];if(x(`set called for property ${String(p)}, current:`,y,"new:",g),ue(y,g))x("Value unchanged, not tracking");else{const C=i.originalObject[p],v=ue(g,C);if(x("value:",g,"original:",C,"isRevertToOriginal:",v),v){x(`Reverting property ${String(p)} to original value`),delete i.assigned_[p.toString()],x(`Updating copy with original value for ${String(p)}`),i.copy_[p]=Y(C),x("Checking if all properties reverted");const E=a(i);x("All reverted:",E),E?(x("All properties reverted, clearing tracking"),i.modified=!1,i.assigned_={},e&&(x("Updating parent for property:",e.prop),c(e.tracker,e.prop))):(x("Some properties still changed, keeping modified flag"),i.modified=!0)}else x(`Setting new value for property ${String(p)}`),i.copy_[p]=g,i.assigned_[p.toString()]=!0,x("Marking object and ancestors as modified",i),o(i)}return!0},defineProperty(f,p,g){return"value"in g&&(i.copy_[p]=Y(g.value),i.assigned_[p.toString()]=!0,o(i)),!0},deleteProperty(f,p){x("deleteProperty",f,p);const g=typeof p=="symbol"?p.toString():p;if(g in f){const y=g in i.originalObject;delete i.copy_[p],y?(i.assigned_[g]=!1,i.copy_[g]=void 0,o(i)):(delete i.copy_[g],delete i.assigned_[g],Object.keys(i.assigned_).length===0&&Object.getOwnPropertySymbols(i.assigned_).length===0?i.modified=!1:i.modified=!0)}return!0}});return r.set(u,d),d}return{proxy:l(n),getChanges:()=>{if(x("getChanges called, modified:",i.modified),x(i),!i.modified)return x("Object not modified, returning empty object"),{};if(typeof i.copy_!="object"||Array.isArray(i.copy_)||Object.keys(i.assigned_).length===0)return i.copy_;const u={};for(const d in i.copy_)i.assigned_[d]===!0&&d in i.copy_&&(u[d]=i.copy_[d]);return x("Returning copy:",u),u}}}function js(n){const e=n.map(t=>Ut(t));return{proxies:e.map(t=>t.proxy),getChanges:()=>e.map(t=>t.getChanges())}}function Js(n,e){const{proxy:t,getChanges:s}=Ut(n);return e(t),s()}function Gs(n,e){const{proxies:t,getChanges:s}=js(n);return e(t),s()}class un{constructor(e){this.map=new Map,this.sortedKeys=[],this.comparator=e||this.defaultComparator}defaultComparator(e,t){return e<t?-1:e>t?1:0}indexOf(e){let t=0,s=this.sortedKeys.length;for(;t<s;){const r=Math.floor((t+s)/2),i=this.sortedKeys[r],o=this.map.get(i),a=this.comparator(e,o);if(a<0)s=r;else if(a>0)t=r+1;else return r}return t}set(e,t){if(this.map.has(e)){const r=this.map.get(e),i=this.indexOf(r);this.sortedKeys.splice(i,1)}const s=this.indexOf(t);return this.sortedKeys.splice(s,0,e),this.map.set(e,t),this}get(e){return this.map.get(e)}delete(e){if(this.map.has(e)){const t=this.map.get(e),s=this.indexOf(t);return this.sortedKeys.splice(s,1),this.map.delete(e)}return!1}has(e){return this.map.has(e)}clear(){this.map.clear(),this.sortedKeys=[]}get size(){return this.map.size}*[Symbol.iterator](){for(const e of this.sortedKeys)yield[e,this.map.get(e)]}entries(){return this[Symbol.iterator]()}keys(){return this.sortedKeys[Symbol.iterator]()}values(){return(function*(){for(const e of this.sortedKeys)yield this.map.get(e)}).call(this)}forEach(e){for(const t of this.sortedKeys)e(this.map.get(t),t,this.map)}}class $e{}class we extends $e{constructor(e,t){super(),this.collection=e,this.alias=t,this.type="collectionRef"}}class L extends $e{constructor(e,t){super(),this.query=e,this.alias=t,this.type="queryRef"}}class se extends $e{constructor(e){super(),this.path=e,this.type="ref"}}class jn extends $e{constructor(e){super(),this.value=e,this.type="val"}}class wt extends $e{constructor(e,t){super(),this.name=e,this.args=t,this.type="func"}}function Jn(n){return typeof n=="object"&&"expression"in n?n.expression:n}function hn(n){return typeof n=="object"&&"expression"in n?n.expression:n}function fn(n){return typeof n=="object"&&"expression"in n&&n.residual===!0}function Hs(n){return{expression:n,residual:!0}}function jt(){const n=new Map;function e(t){const s=t.join(".");if(n.has(s))return n.get(s);const r=new Proxy({},{get(i,o,a){if(o==="__refProxy")return!0;if(o==="__path")return t;if(o==="__type")return;if(typeof o=="symbol")return Reflect.get(i,o,a);const c=[...t,String(o)];return e(c)},has(i,o){return o==="__refProxy"||o==="__path"||o==="__type"?!0:Reflect.has(i,o)},ownKeys(i){return Reflect.ownKeys(i)},getOwnPropertyDescriptor(i,o){return o==="__refProxy"||o==="__path"||o==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(i,o)}});return n.set(s,r),r}return e([])}function he(n){const e=new Map,t=new Set;function s(i){const o=i.join(".");if(e.has(o))return e.get(o);const a=new Proxy({},{get(c,l,h){if(l==="__refProxy")return!0;if(l==="__path")return i;if(l==="__type")return;if(typeof l=="symbol")return Reflect.get(c,l,h);const u=[...i,String(l)];return s(u)},has(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?!0:Reflect.has(c,l)},ownKeys(c){if(i.length===1){const l=i[0];t.add(l)}return Reflect.ownKeys(c)},getOwnPropertyDescriptor(c,l){return l==="__refProxy"||l==="__path"||l==="__type"?{enumerable:!1,configurable:!0}:Reflect.getOwnPropertyDescriptor(c,l)}});return e.set(o,a),a}return new Proxy({},{get(i,o,a){if(o==="__refProxy")return!0;if(o==="__path")return[];if(o==="__type")return;if(o==="__spreadSentinels")return t;if(typeof o=="symbol")return Reflect.get(i,o,a);const c=String(o);if(n.includes(c))return s([c])},has(i,o){return o==="__refProxy"||o==="__path"||o==="__type"||o==="__spreadSentinels"||typeof o=="string"&&n.includes(o)?!0:Reflect.has(i,o)},ownKeys(i){return[...n,"__refProxy","__path","__type","__spreadSentinels"]},getOwnPropertyDescriptor(i,o){if(o==="__refProxy"||o==="__path"||o==="__type"||o==="__spreadSentinels")return{enumerable:!1,configurable:!0};if(typeof o=="string"&&n.includes(o))return{enumerable:!0,configurable:!0}}})}function B(n){return Gn(n)?new se(n.__path):n&&typeof n=="object"&&"type"in n&&(n.type==="func"||n.type==="ref"||n.type==="val"||n.type==="agg")?n:new jn(n)}function Gn(n){return n&&typeof n=="object"&&n.__refProxy===!0}class qs{constructor(e,t,s){this._root=kt,this._size=0,this._maxNodeSize=s>=4?Math.min(s,256):32,this._compare=e,t&&this.setPairs(t)}get size(){return this._size}get length(){return this._size}get isEmpty(){return this._size===0}clear(){this._root=kt,this._size=0}get(e,t){return this._root.get(e,t,this)}set(e,t,s){this._root.isShared&&(this._root=this._root.clone());const r=this._root.set(e,t,s,this);return r===!0||r===!1?r:(this._root=new Jt([this._root,r]),!0)}has(e){return this.forRange(e,e,!0,void 0)!==0}delete(e){return this.editRange(e,e,!0,Qs)!==0}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}keysArray(){const e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,(t,s)=>{e.push(t)}),e}nextHigherPair(e,t){return t=t||[],e===void 0?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)}nextHigherKey(e){const t=this.nextHigherPair(e,dn);return t&&t[0]}nextLowerPair(e,t){return t=t||[],e===void 0?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)}nextLowerKey(e){const t=this.nextLowerPair(e,dn);return t&&t[0]}setPairs(e,t){let s=0;for(const r of e)this.set(r[0],r[1],t)&&s++;return s}forRange(e,t,s,r,i){const o=this._root.forRange(e,t,s,!1,this,i||0,r);return typeof o=="number"?o:o.break}editRange(e,t,s,r,i){let o=this._root;o.isShared&&(this._root=o=o.clone());try{const a=o.forRange(e,t,s,!0,this,i||0,r);return typeof a=="number"?a:a.break}finally{let a;for(;o.keys.length<=1&&!o.isLeaf;)a||(a=o.isShared),this._root=o=o.keys.length===0?kt:o.children[0];a&&(o.isShared=!0)}}}class Ae{get isLeaf(){return this.children===void 0}constructor(e=[],t){this.keys=e,this.values=t||O,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,t,s){const r=this.keys;let i=0,o=r.length,a=o>>1;for(;i<o;){const c=s(r[a],e);if(c<0)i=a+1;else if(c>0)o=a;else{if(c===0)return a;if(e===e)return r.length;throw new Error("BTree: NaN was used as a key")}a=i+o>>1}return a^t}minKey(){return this.keys[0]}minPair(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(this.keys.length===0)return;const t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}clone(){const e=this.values;return new Ae(this.keys.slice(0),e===O?e:e.slice(0))}get(e,t,s){const r=this.indexOf(e,-1,s._compare);return r<0?t:this.values[r]}getPairOrNextLower(e,t,s,r){const i=this.indexOf(e,-1,t),o=i<0?~i-1:s?i:i-1;if(o>=0)return r[0]=this.keys[o],r[1]=this.values[o],r}getPairOrNextHigher(e,t,s,r){const i=this.indexOf(e,-1,t),o=i<0?~i:s?i:i+1,a=this.keys;if(o<a.length)return r[0]=a[o],r[1]=this.values[o],r}set(e,t,s,r){let i=this.indexOf(e,-1,r._compare);if(i<0){if(i=~i,r._size++,this.keys.length<r._maxNodeSize)return this.insertInLeaf(i,e,t,r);{const o=this.splitOffRightSide();let a=this;return i>this.keys.length&&(i-=this.keys.length,a=o),a.insertInLeaf(i,e,t,r),o}}else return s!==!1&&(t!==void 0&&this.reifyValues(),this.keys[i]=e,this.values[i]=t),!1}reifyValues(){return this.values===O?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,t,s,r){if(this.keys.splice(e,0,t),this.values===O){for(;O.length<r._maxNodeSize;)O.push(void 0);if(s===void 0)return!0;this.values=O.slice(0,this.keys.length-1)}return this.values.splice(e,0,s),!0}takeFromRight(e){let t=this.values;e.values===O?t!==O&&t.push(void 0):(t=this.reifyValues(),t.push(e.values.shift())),this.keys.push(e.keys.shift())}takeFromLeft(e){let t=this.values;e.values===O?t!==O&&t.unshift(void 0):(t=this.reifyValues(),t.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())}splitOffRightSide(){const e=this.keys.length>>1,t=this.keys.splice(e),s=this.values===O?O:this.values.splice(e);return new Ae(t,s)}forRange(e,t,s,r,i,o,a){const c=i._compare;let l,h;if(t===e){if(!s||(h=(l=this.indexOf(e,-1,c))+1,l<0))return o}else l=this.indexOf(e,0,c),h=this.indexOf(t,-1,c),h<0?h=~h:s===!0&&h++;const u=this.keys,d=this.values;if(a!==void 0)for(let f=l;f<h;f++){const p=u[f],g=a(p,d[f],o++);if(g!==void 0){if(r===!0){if(p!==u[f]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");g.delete?(this.keys.splice(f,1),this.values!==O&&this.values.splice(f,1),i._size--,f--,h--):g.hasOwnProperty("value")&&(d[f]=g.value)}if(g.break!==void 0)return g}}else o+=h-l;return o}mergeSibling(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===O){if(e.values===O)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}}class Jt extends Ae{constructor(e,t){if(!t){t=[];for(let s=0;s<e.length;s++)t[s]=e[s].maxKey()}super(t),this.children=e}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,t,s){const r=this.indexOf(e,0,s._compare),i=this.children;return r<i.length?i[r].get(e,t,s):void 0}getPairOrNextLower(e,t,s,r){const i=this.indexOf(e,0,t),o=this.children;if(i>=o.length)return this.maxPair(r);const a=o[i].getPairOrNextLower(e,t,s,r);return a===void 0&&i>0?o[i-1].maxPair(r):a}getPairOrNextHigher(e,t,s,r){const i=this.indexOf(e,0,t),o=this.children,a=o.length;if(i>=a)return;const c=o[i].getPairOrNextHigher(e,t,s,r);return c===void 0&&i<a-1?o[i+1].minPair(r):c}set(e,t,s,r){const i=this.children,o=r._maxNodeSize,a=r._compare;let c=Math.min(this.indexOf(e,0,a),i.length-1),l=i[c];if(l.isShared&&(i[c]=l=l.clone()),l.keys.length>=o){let u;c>0&&(u=i[c-1]).keys.length<o&&a(l.keys[0],e)<0?(u.isShared&&(i[c-1]=u=u.clone()),u.takeFromRight(l),this.keys[c-1]=u.maxKey()):(u=i[c+1])!==void 0&&u.keys.length<o&&a(l.maxKey(),e)<0&&(u.isShared&&(i[c+1]=u=u.clone()),u.takeFromLeft(l),this.keys[c]=i[c].maxKey())}const h=l.set(e,t,s,r);if(h===!1)return!1;if(this.keys[c]=l.maxKey(),h===!0)return!0;if(this.keys.length<o)return this.insert(c+1,h),!0;{const u=this.splitOffRightSide();let d=this;return a(h.maxKey(),this.maxKey())>0&&(d=u,c-=this.keys.length),d.insert(c+1,h),u}}insert(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())}splitOffRightSide(){const e=this.children.length>>1;return new Jt(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,t,s,r,i,o,a){const c=i._compare,l=this.keys,h=this.children;let u=this.indexOf(e,0,c),d=u;const f=Math.min(t===e?u:this.indexOf(t,0,c),l.length-1);if(r){if(d<=f)try{for(;d<=f;d++){h[d].isShared&&(h[d]=h[d].clone());const p=h[d].forRange(e,t,s,r,i,o,a);if(l[d]=h[d].maxKey(),typeof p!="number")return p;o=p}}finally{const p=i._maxNodeSize>>1;for(u>0&&u--,d=f;d>=u;d--)h[d].keys.length<=p&&(h[d].keys.length!==0?this.tryMerge(d,i._maxNodeSize):(l.splice(d,1),h.splice(d,1)));h.length!==0&&h[0].keys.length===0&&Zs(!1,"emptiness bug")}}else for(;d<=f;d++){const p=h[d].forRange(e,t,s,r,i,o,a);if(typeof p!="number")return p;o=p}return o}tryMerge(e,t){const s=this.children;return e>=0&&e+1<s.length&&s[e].keys.length+s[e+1].keys.length<=t?(s[e].isShared&&(s[e]=s[e].clone()),s[e].mergeSibling(s[e+1],t),s.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=s[e].maxKey(),!0):!1}mergeSibling(e,t){const s=this.keys.length;this.keys.push.apply(this.keys,e.keys);const r=e.children;if(this.children.push.apply(this.children,r),e.isShared&&!this.isShared)for(const i of r)i.isShared=!0;this.tryMerge(s-1,t)}}const O=[],Ys={delete:!0},Qs=()=>Ys,kt=(function(){const n=new Ae;return n.isShared=!0,n})(),dn=[];function Zs(n,...e){throw e.unshift("B+ tree"),new Error(e.join(" "))}const It=new WeakMap;let Xs=1;function pn(n){if(It.has(n))return It.get(n);const e=Xs++;return It.set(n,e),e}const Gt=(n,e,t)=>{const{nulls:s}=t;if(n==null&&e==null)return 0;if(n==null)return s==="first"?-1:1;if(e==null)return s==="first"?1:-1;if(typeof n=="string"&&typeof e=="string"&&t.stringSort==="locale")return n.localeCompare(e,t.locale,t.localeOptions);if(Array.isArray(n)&&Array.isArray(e)){for(let o=0;o<Math.min(n.length,e.length);o++){const a=Gt(n[o],e[o],t);if(a!==0)return a}return n.length-e.length}if(n instanceof Date&&e instanceof Date)return n.getTime()-e.getTime();const r=typeof n=="object",i=typeof e=="object";if(r||i){if(r&&i){const o=pn(n),a=pn(e);return o-a}if(r)return 1;if(i)return-1}return n<e?-1:n>e?1:0},er=(n,e,t)=>Gt(e,n,{...t,nulls:t.nulls==="first"?"last":"first"});function Kt(n){return(e,t)=>n.direction==="asc"?Gt(e,t,n):er(e,t,n)}const zt=Kt({direction:"asc",nulls:"first",stringSort:"locale"});class F extends Error{constructor(e){super(e),this.name="TanStackDBError"}}class gn extends F{constructor(e,t,s){const r=`${e==="insert"?"Insert":"Update"} validation failed: ${t.map(i=>`
- ${i.message} - path: ${i.path}`).join("")}`;super(s||r),this.name="SchemaValidationError",this.type=e,this.issues=t}}class xt extends F{constructor(e){super(e),this.name="CollectionConfigurationError"}}class tr extends xt{constructor(){super("Collection requires a config")}}class nr extends xt{constructor(){super("Collection requires a sync config")}}class sr extends xt{constructor(){super("Schema must implement the standard-schema interface")}}class yn extends xt{constructor(){super("Schema validation must be synchronous")}}class _t extends F{constructor(e){super(e),this.name="CollectionStateError"}}class rr extends _t{constructor(e,t){super(`Cannot perform ${e} on collection "${t}" - collection is in error state. Try calling cleanup() and restarting the collection.`)}}class ir extends _t{constructor(e,t,s){super(`Invalid collection status transition from "${e}" to "${t}" for collection "${s}"`)}}class or extends _t{constructor(){super("Collection is in error state")}}class ar extends _t{constructor(){super("Active subscribers count is negative - this should never happen")}}class Z extends F{constructor(e){super(e),this.name="CollectionOperationError"}}class cr extends Z{constructor(e){super(`An object was created without a defined key: ${JSON.stringify(e)}`)}}class lr extends Z{constructor(e){super(`Cannot insert document with ID "${e}" because it already exists in the collection`)}}class ur extends Z{constructor(e,t){super(`Cannot insert document with key "${e}" from sync because it already exists in the collection "${t}"`)}}class hr extends Z{constructor(){super("The first argument to update is missing")}}class fr extends Z{constructor(){super("No keys were passed to update")}}class dr extends Z{constructor(e){super(`The key "${e}" was passed to update but an object for this key was not found in the collection`)}}class pr extends Z{constructor(e,t){super(`Updating the key of an item is not allowed. Original key: "${e}", Attempted new key: "${t}". Please delete the old item and create a new one if a key change is necessary.`)}}class gr extends Z{constructor(){super("No keys were passed to delete")}}class yr extends Z{constructor(e){super(`Collection.delete was called with key '${e}' but there is no item in the collection with this key`)}}class Ht extends F{constructor(e){super(e),this.name="MissingHandlerError"}}class mr extends Ht{constructor(){super("Collection.insert called directly (not within an explicit transaction) but no 'onInsert' handler is configured.")}}class vr extends Ht{constructor(){super("Collection.update called directly (not within an explicit transaction) but no 'onUpdate' handler is configured.")}}class wr extends Ht{constructor(){super("Collection.delete called directly (not within an explicit transaction) but no 'onDelete' handler is configured.")}}class re extends F{constructor(e){super(e),this.name="TransactionError"}}class xr extends re{constructor(){super("mutationFn is required when creating a transaction")}}class _r extends re{constructor(){super("You can no longer call .mutate() as the transaction is no longer pending")}}class Sr extends re{constructor(){super("You can no longer call .rollback() as the transaction is already completed")}}class Cr extends re{constructor(){super("You can no longer call .commit() as the transaction is no longer pending")}}class mn extends re{constructor(){super("No pending sync transaction to write to")}}class vn extends re{constructor(){super("The pending sync transaction is already committed, you can't still write to it.")}}class kr extends re{constructor(){super("No pending sync transaction to commit")}}class Ir extends re{constructor(){super("The pending sync transaction is already committed, you can't commit it again.")}}class Fe extends F{constructor(e){super(e),this.name="QueryBuilderError"}}class Er extends Fe{constructor(e){super(`Only one source is allowed in the ${e}`)}}class br extends Fe{constructor(e){super(`A sub query passed to a ${e} must have a from clause itself`)}}class Rr extends Fe{constructor(e){super(`Invalid source for live query: The value provided for alias "${e}" is not a Collection or subquery. Live queries only accept Collection instances or subqueries. Please ensure you're passing a valid Collection or QueryBuilder, not a plain array or other data type.`)}}class Or extends Fe{constructor(){super("Join condition must be an equality expression")}}class Mr extends Fe{constructor(){super("Query must have a from clause")}}class X extends F{constructor(e){super(e),this.name="QueryCompilationError"}}class Tr extends X{constructor(){super("DISTINCT requires a SELECT clause.")}}class Ar extends X{constructor(){super("HAVING clause requires GROUP BY clause")}}class Pr extends X{constructor(){super("LIMIT and OFFSET require an ORDER BY clause to ensure deterministic results")}}class Hn extends X{constructor(e){super(`Input for collection "${e}" not found in inputs map`)}}class Kr extends X{constructor(e){super(`Unsupported FROM type: ${e}`)}}class zr extends X{constructor(e){super(`Unknown expression type: ${e}`)}}class $r extends X{constructor(){super("Reference path cannot be empty")}}class Fr extends X{constructor(e){super(`Unknown function: ${e}`)}}class wn extends X{constructor(e){super(`Collection "${e}" not found during compilation of join`)}}class De extends F{constructor(e){super(e),this.name="JoinError"}}class Dr extends De{constructor(e){super(`Unsupported join type: ${e}`)}}class Nr extends De{constructor(e){super(`Invalid join condition: both expressions refer to the same table "${e}"`)}}class Wr extends De{constructor(e,t){super(`Invalid join condition: expressions must reference table aliases "${e}" and "${t}"`)}}class Br extends De{constructor(e,t,s,r){super(`Invalid join condition: expressions reference tables "${e}" and "${t}" but join is between "${s}" and "${r}"`)}}class Vr extends De{constructor(e){super(`Unsupported join source type: ${e}`)}}class St extends F{constructor(e){super(e),this.name="GroupByError"}}class Lr extends St{constructor(e){super(`Non-aggregate expression '${e}' in SELECT must also appear in GROUP BY clause`)}}class Ur extends St{constructor(e){super(`Unsupported aggregate function: ${e}`)}}class jr extends St{constructor(e){super(`Aggregate function in HAVING clause must also be in SELECT clause: ${e}`)}}class Jr extends St{constructor(e){super(`Unknown expression type in HAVING clause: ${e}`)}}class xn extends F{constructor(e,t){const s=t instanceof Error?t.message:String(t);super(`Collection "${e}" sync cleanup function threw an error: ${s}`),this.name="SyncCleanupError"}}class Gr extends F{constructor(e){super(e),this.name="QueryOptimizerError"}}class Hr extends Gr{constructor(){super("Cannot combine empty expression list")}}function J(n,e=!1){return Yt(n,e)}function qt(n){return Yt(n,!0)}function Yt(n,e){switch(n.type){case"val":{const t=n.value;return()=>t}case"ref":return e?Yr(n):qr(n);case"func":return Qr(n,e);default:throw new zr(n.type)}}function qr(n){const[e,...t]=n.path;if(!e)throw new $r;if(t.length===0)return s=>s[e];if(t.length===1){const s=t[0];return r=>{const i=r[e];return i?.[s]}}else return s=>{const r=s[e];if(r===void 0)return;let i=r;for(const o of t){if(i==null)return i;i=i[o]}return i}}function Yr(n){const e=n.path;return t=>{let s=t;for(const r of e){if(s==null)return s;s=s[r]}return s}}function Qr(n,e){const t=n.args.map(s=>Yt(s,e));switch(n.name){case"eq":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return o===a}}case"gt":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return o>a}}case"gte":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return o>=a}}case"lt":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return o<a}}case"lte":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return o<=a}}case"and":return s=>{for(const r of t)if(!r(s))return!1;return!0};case"or":return s=>{for(const r of t)if(r(s))return!0;return!1};case"not":{const s=t[0];return r=>!s(r)}case"in":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return Array.isArray(a)?a.includes(o):!1}}case"like":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return _n(o,a,!1)}}case"ilike":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return _n(o,a,!0)}}case"upper":{const s=t[0];return r=>{const i=s(r);return typeof i=="string"?i.toUpperCase():i}}case"lower":{const s=t[0];return r=>{const i=s(r);return typeof i=="string"?i.toLowerCase():i}}case"length":{const s=t[0];return r=>{const i=s(r);return typeof i=="string"||Array.isArray(i)?i.length:0}}case"concat":return s=>t.map(r=>{const i=r(s);try{return String(i??"")}catch{try{return JSON.stringify(i)||""}catch{return"[object]"}}}).join("");case"coalesce":return s=>{for(const r of t){const i=r(s);if(i!=null)return i}return null};case"add":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return(o??0)+(a??0)}}case"subtract":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return(o??0)-(a??0)}}case"multiply":{const s=t[0],r=t[1];return i=>{const o=s(i),a=r(i);return(o??0)*(a??0)}}case"divide":{const s=t[0],r=t[1];return i=>{const o=s(i),c=r(i)??0;return c!==0?(o??0)/c:null}}default:throw new Fr(n.name)}}function _n(n,e,t){if(typeof n!="string"||typeof e!="string")return!1;const s=t?n.toLowerCase():n;let i=(t?e.toLowerCase():e).replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return i=i.replace(/%/g,".*"),i=i.replace(/_/g,"."),new RegExp(`^${i}$`).test(s)}function ga(n,e){return new wt("eq",[B(n),B(e)])}class Zr{constructor(e,t,s,r){this.lookupCount=0,this.totalLookupTime=0,this.lastUpdated=new Date,this.id=e,this.expression=t,this.name=s,this.initialize(r)}supports(e){return this.supportedOperations.has(e)}matchesField(e){return this.expression.type==="ref"&&this.expression.path.length===e.length&&this.expression.path.every((t,s)=>t===e[s])}getStats(){return{entryCount:this.keyCount,lookupCount:this.lookupCount,averageLookupTime:this.lookupCount>0?this.totalLookupTime/this.lookupCount:0,lastUpdated:this.lastUpdated}}evaluateIndexExpression(e){return qt(this.expression)(e)}trackLookup(e){const t=performance.now()-e;this.lookupCount++,this.totalLookupTime+=t}updateTimestamp(){this.lastUpdated=new Date}}class $t extends Zr{constructor(e,t,s,r){super(e,t,s,r),this.supportedOperations=new Set(["eq","gt","gte","lt","lte","in"]),this.valueMap=new Map,this.indexedKeys=new Set,this.compareFn=zt,this.compareFn=r?.compareFn??zt,this.orderedEntries=new qs(this.compareFn)}initialize(e){}add(e,t){let s;try{s=this.evaluateIndexExpression(t)}catch(r){throw new Error(`Failed to evaluate index expression for key ${e}: ${r}`)}if(this.valueMap.has(s))this.valueMap.get(s).add(e);else{const r=new Set([e]);this.valueMap.set(s,r),this.orderedEntries.set(s,void 0)}this.indexedKeys.add(e),this.updateTimestamp()}remove(e,t){let s;try{s=this.evaluateIndexExpression(t)}catch(r){console.warn(`Failed to evaluate index expression for key ${e} during removal:`,r);return}if(this.valueMap.has(s)){const r=this.valueMap.get(s);r.delete(e),r.size===0&&(this.valueMap.delete(s),this.orderedEntries.delete(s))}this.indexedKeys.delete(e),this.updateTimestamp()}update(e,t,s){this.remove(e,t),this.add(e,s)}build(e){this.clear();for(const[t,s]of e)this.add(t,s)}clear(){this.orderedEntries.clear(),this.valueMap.clear(),this.indexedKeys.clear(),this.updateTimestamp()}lookup(e,t){const s=performance.now();let r;switch(e){case"eq":r=this.equalityLookup(t);break;case"gt":r=this.rangeQuery({from:t,fromInclusive:!1});break;case"gte":r=this.rangeQuery({from:t,fromInclusive:!0});break;case"lt":r=this.rangeQuery({to:t,toInclusive:!1});break;case"lte":r=this.rangeQuery({to:t,toInclusive:!0});break;case"in":r=this.inArrayLookup(t);break;default:throw new Error(`Operation ${e} not supported by BTreeIndex`)}return this.trackLookup(s),r}get keyCount(){return this.indexedKeys.size}equalityLookup(e){return new Set(this.valueMap.get(e)??[])}rangeQuery(e={}){const{from:t,to:s,fromInclusive:r=!0,toInclusive:i=!0}=e,o=new Set,a=t??this.orderedEntries.minKey(),c=s??this.orderedEntries.maxKey();return this.orderedEntries.forRange(a,c,i,(l,h)=>{if(!r&&this.compareFn(l,t)===0)return;const u=this.valueMap.get(l);u&&u.forEach(d=>o.add(d))}),o}take(e,t){const s=new Set,r=[],i=a=>this.orderedEntries.nextHigherKey(a);let o=t;for(;(o=i(o))&&r.length<e;){const a=this.valueMap.get(o);if(a){const c=a.values();let l;for(;r.length<e&&(l=c.next().value);)s.has(l)||(r.push(l),s.add(l))}}return r}inArrayLookup(e){const t=new Set;for(const s of e){const r=this.valueMap.get(s);r&&r.forEach(i=>t.add(i))}return t}get indexedKeysSet(){return this.indexedKeys}get orderedEntriesArray(){return this.orderedEntries.keysArray().map(e=>[e,this.valueMap.get(e)??new Set])}get valueMapData(){return this.valueMap}}function qn(n){return typeof n=="function"&&n.prototype!==void 0&&n.prototype.constructor===n}async function Xr(n){return qn(n)?n:await n()}class ei{constructor(e,t,s,r,i,o){this.id=e,this.expression=t,this.name=s,this.resolver=r,this.options=i,this.collectionEntries=o,this.indexPromise=null,this.resolvedIndex=null,qn(this.resolver)&&(this.resolvedIndex=new this.resolver(this.id,this.expression,this.name,this.options),this.collectionEntries&&this.resolvedIndex.build(this.collectionEntries))}async resolve(){return this.resolvedIndex?this.resolvedIndex:(this.indexPromise||(this.indexPromise=this.createIndex()),this.resolvedIndex=await this.indexPromise,this.resolvedIndex)}isResolved(){return this.resolvedIndex!==null}getResolved(){if(!this.resolvedIndex)throw new Error(`Index ${this.id} has not been resolved yet. Ensure collection is synced.`);return this.resolvedIndex}getId(){return this.id}getName(){return this.name}getExpression(){return this.expression}async createIndex(){const e=await Xr(this.resolver);return new e(this.id,this.expression,this.name,this.options)}}class ti{constructor(e,t){this.indexId=e,this.lazyIndex=t}get index(){return this.lazyIndex.getResolved()}get isReady(){return this.lazyIndex.isResolved()}async whenReady(){return await this.lazyIndex.resolve()}get id(){return this.indexId}get name(){return this.isReady?this.index.name:this.lazyIndex.getName()}get expression(){return this.lazyIndex.getExpression()}supports(e){return this.index.supports(e)}getStats(){return this.index.getStats()}matchesField(e){const t=this.expression;return t.type==="ref"&&t.path.length===e.length&&t.path.every((s,r)=>s===e[r])}get keyCount(){return this.index.keyCount}get indexedKeysSet(){return this.index.indexedKeysSet}get orderedEntriesArray(){return this.index.orderedEntriesArray}get valueMapData(){return this.index.valueMapData}equalityLookup(e){var t;const s=this.index;return((t=s.equalityLookup)==null?void 0:t.call(s,e))??new Set}rangeQuery(e){var t;const s=this.index;return((t=s.rangeQuery)==null?void 0:t.call(s,e))??new Set}inArrayLookup(e){var t;const s=this.index;return((t=s.inArrayLookup)==null?void 0:t.call(s,e))??new Set}_getLazyWrapper(){return this.lazyIndex}}function Yn(n){return!(n.config.autoIndex!=="eager"||n.status==="loading"||n.status==="initialCommit")}function Qt(n,e,t,s){if(!(!Yn(t)||Array.from(t.indexes.values()).find(i=>i.matchesField(e))))try{t.createIndex(i=>i[n],{name:`auto_${n}`,indexType:$t,options:s?{compareFn:s}:{}})}catch(i){console.warn(`Failed to create auto-index for field "${n}":`,i)}}function ni(n,e){if(!Yn(e))return;const t=si(n);for(const{fieldName:s,fieldPath:r}of t)Qt(s,r,e)}function si(n){const e=[];function t(s){if(s.type!=="func")return;const r=s;if(r.name==="and"){for(const l of r.args)t(l);return}if(!["eq","gt","gte","lt","lte","in"].includes(r.name)||r.args.length<1||r.args[0].type!=="ref")return;const a=r.args[0].path;if(a.length!==1)return;const c=a[0];e.push({fieldName:c,fieldPath:a})}return t(n),e}function ri(){let n,e,t=!0;return{promise:new Promise((r,i)=>{n=o=>{t=!1,r(o)},e=o=>{t=!1,i(o)}}),resolve:n,reject:e,isPending:()=>t}}const at=[];let Pe=[],ii=0;function Be(n){const e=new li(n);return at.push(e),e}function Et(){if(Pe.length>0)return Pe.slice(-1)[0]}function oi(n){Pe.push(n)}function ai(n){Pe=Pe.filter(e=>e.id!==n.id)}function ci(n){const e=at.findIndex(t=>t.id===n.id);e!==-1&&at.splice(e,1)}class li{constructor(e){if(typeof e.mutationFn>"u")throw new xr;this.id=e.id??crypto.randomUUID(),this.mutationFn=e.mutationFn,this.state="pending",this.mutations=[],this.isPersisted=ri(),this.autoCommit=e.autoCommit??!0,this.createdAt=new Date,this.sequenceNumber=ii++,this.metadata=e.metadata??{}}setState(e){this.state=e,(e==="completed"||e==="failed")&&ci(this)}mutate(e){if(this.state!=="pending")throw new _r;oi(this);try{e()}finally{ai(this)}return this.autoCommit&&this.commit(),this}applyMutations(e){for(const t of e){const s=this.mutations.findIndex(r=>r.globalKey===t.globalKey);s>=0?this.mutations[s]=t:this.mutations.push(t)}}rollback(e){var t;const s=e?.isSecondaryRollback??!1;if(this.state==="completed")throw new Sr;if(this.setState("failed"),!s){const r=new Set;this.mutations.forEach(i=>r.add(i.globalKey));for(const i of at)i.state==="pending"&&i.mutations.some(o=>r.has(o.globalKey))&&i.rollback({isSecondaryRollback:!0})}return this.isPersisted.reject((t=this.error)==null?void 0:t.error),this.touchCollection(),this}touchCollection(){const e=new Set;for(const t of this.mutations)e.has(t.collection.id)||(t.collection.onTransactionStateChange(),t.collection.pendingSyncedTransactions.length>0&&t.collection.commitPendingTransactions(),e.add(t.collection.id))}async commit(){if(this.state!=="pending")throw new Cr;if(this.setState("persisting"),this.mutations.length===0)return this.setState("completed"),this.isPersisted.resolve(this),this;try{await this.mutationFn({transaction:this}),this.setState("completed"),this.touchCollection(),this.isPersisted.resolve(this)}catch(e){return this.error={message:e instanceof Error?e.message:String(e),error:e instanceof Error?e:new Error(String(e))},this.rollback()}return this}compareCreatedAt(e){const t=this.createdAt.getTime()-e.createdAt.getTime();return t!==0?t:this.sequenceNumber-e.sequenceNumber}}function Ne(n,e){for(const t of n.values())if(t.matchesField(e))return t}function ui(n){if(n.length===0)return new Set;if(n.length===1)return new Set(n[0]);let e=new Set(n[0]);for(let t=1;t<n.length;t++){const s=new Set;for(const r of e)n[t].has(r)&&s.add(r);e=s}return e}function hi(n){const e=new Set;for(const t of n)for(const s of t)e.add(s);return e}function fi(n,e){return Zt(n,e)}function Zt(n,e){if(n.type==="func")switch(n.name){case"eq":case"gt":case"gte":case"lt":case"lte":return pi(n,e);case"and":return gi(n,e);case"or":return yi(n,e);case"in":return mi(n,e)}return{canOptimize:!1,matchingKeys:new Set}}function di(n,e){if(n.type!=="func"||n.args.length<2)return{canOptimize:!1,matchingKeys:new Set};const t=new Map;for(const s of n.args)if(s.type==="func"&&["gt","gte","lt","lte"].includes(s.name)){const r=s;if(r.args.length===2){const i=r.args[0],o=r.args[1];let a=null,c=null,l=r.name;if(i.type==="ref"&&o.type==="val")a=i,c=o;else if(i.type==="val"&&o.type==="ref")switch(a=o,c=i,l){case"gt":l="lt";break;case"gte":l="lte";break;case"lt":l="gt";break;case"lte":l="gte";break}if(a&&c){const u=a.path.join("."),d=c.value;t.has(u)||t.set(u,[]),t.get(u).push({operation:l,value:d})}}}for(const[s,r]of t)if(r.length>=2){const i=s.split("."),o=Ne(e,i);if(o&&o.supports("gt")&&o.supports("lt")){let a,c,l=!0,h=!0;for(const{operation:d,value:f}of r)switch(d){case"gt":(a===void 0||f>a)&&(a=f,l=!1);break;case"gte":(a===void 0||f>a)&&(a=f,l=!0);break;case"lt":(c===void 0||f<c)&&(c=f,h=!1);break;case"lte":(c===void 0||f<c)&&(c=f,h=!0);break}return{canOptimize:!0,matchingKeys:o.rangeQuery({from:a,to:c,fromInclusive:l,toInclusive:h})}}}return{canOptimize:!1,matchingKeys:new Set}}function pi(n,e){if(n.type!=="func"||n.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};const t=n.args[0],s=n.args[1];let r=null,i=null,o=n.name;if(t.type==="ref"&&s.type==="val")r=t,i=s;else if(t.type==="val"&&s.type==="ref")switch(r=s,i=t,o){case"gt":o="lt";break;case"gte":o="lte";break;case"lt":o="gt";break;case"lte":o="gte";break}if(r&&i){const a=r.path,c=Ne(e,a);if(c){const l=i.value,h=o;return c.supports(h)?{canOptimize:!0,matchingKeys:c.lookup(h,l)}:{canOptimize:!1,matchingKeys:new Set}}}return{canOptimize:!1,matchingKeys:new Set}}function gi(n,e){if(n.type!=="func"||n.args.length<2)return{canOptimize:!1,matchingKeys:new Set};const t=di(n,e);if(t.canOptimize)return t;const s=[];for(const r of n.args){const i=Zt(r,e);i.canOptimize&&s.push(i)}if(s.length>0){const r=s.map(o=>o.matchingKeys);return{canOptimize:!0,matchingKeys:ui(r)}}return{canOptimize:!1,matchingKeys:new Set}}function yi(n,e){if(n.type!=="func"||n.args.length<2)return{canOptimize:!1,matchingKeys:new Set};const t=[];for(const s of n.args){const r=Zt(s,e);r.canOptimize&&t.push(r)}if(t.length>0){const s=t.map(i=>i.matchingKeys);return{canOptimize:!0,matchingKeys:hi(s)}}return{canOptimize:!1,matchingKeys:new Set}}function mi(n,e){if(n.type!=="func"||n.args.length!==2)return{canOptimize:!1,matchingKeys:new Set};const t=n.args[0],s=n.args[1];if(t.type==="ref"&&s.type==="val"&&Array.isArray(s.value)){const r=t.path,i=s.value,o=Ne(e,r);if(o){if(o.supports("in"))return{canOptimize:!0,matchingKeys:o.lookup("in",i)};if(o.supports("eq")){const a=new Set;for(const c of i){const l=o.lookup("eq",c);for(const h of l)a.add(h)}return{canOptimize:!0,matchingKeys:a}}}}return{canOptimize:!1,matchingKeys:new Set}}function vi(n,e={}){const t=s=>{const r=[];for(const[i,o]of n.entries())(s?.(o)??!0)&&r.push({type:"insert",key:i,value:o});return r};if(!e.where&&!e.whereExpression)return t();try{let s;if(e.whereExpression)s=e.whereExpression;else if(e.where){const i=jt(),o=e.where(i);s=B(o)}else return[];const r=fi(s,n.indexes);if(r.canOptimize){const i=[];for(const o of r.matchingKeys){const a=n.get(o);a!==void 0&&i.push({type:"insert",key:o,value:a})}return i}else{const i=e.where?Ft(e.where):ct(s);return t(i)}}catch(s){console.warn("Error processing where clause, falling back to full scan:",s);const r=e.where?Ft(e.where):ct(e.whereExpression);return t(r)}}function Ft(n){return e=>{try{const t=jt(),s=n(t),r=B(s);return qt(r)(e)}catch{try{const t=new Proxy(e,{get(r,i){return r[i]}});return n(t)}catch{return!1}}}}function ct(n){return e=>{try{return!!qt(n)(e)}catch{return!1}}}function wi(n,e){const t=e.whereExpression?ct(e.whereExpression):Ft(e.where);return s=>{const r=[];for(const i of s)if(i.type==="insert")t(i.value)&&r.push(i);else if(i.type==="update"){const o=t(i.value),a=i.previousValue?t(i.previousValue):!1;o&&a?r.push(i):o&&!a?r.push({...i,type:"insert"}):!o&&a&&r.push({...i,type:"delete",value:i.previousValue})}else t(i.value)&&r.push(i);(r.length>0||s.length===0)&&n(r)}}function xi(n){const e=new Qn(n);return n.utils?e.utils={...n.utils}:e.utils={},e}class Qn{constructor(e){if(this.pendingSyncedTransactions=[],this.syncedMetadata=new Map,this.optimisticUpserts=new Map,this.optimisticDeletes=new Set,this._size=0,this.lazyIndexes=new Map,this.resolvedIndexes=new Map,this.isIndexesResolved=!1,this.indexCounter=0,this.changeListeners=new Set,this.changeKeyListeners=new Map,this.utils={},this.syncedKeys=new Set,this.preSyncVisibleState=new Map,this.recentlySyncedKeys=new Set,this.hasReceivedFirstCommit=!1,this.isCommittingSyncTransactions=!1,this.onFirstReadyCallbacks=[],this.hasBeenReady=!1,this.batchedEvents=[],this.shouldBatchEvents=!1,this._status="idle",this.activeSubscribersCount=0,this.gcTimeoutId=null,this.preloadPromise=null,this.syncCleanupFn=null,this.id="",this.commitPendingTransactions=()=>{let t=!1;for(const o of this.transactions.values())if(o.state==="persisting"){t=!0;break}const{committedSyncedTransactions:s,uncommittedSyncedTransactions:r,hasTruncateSync:i}=this.pendingSyncedTransactions.reduce((o,a)=>(a.committed?(o.committedSyncedTransactions.push(a),a.truncate===!0&&(o.hasTruncateSync=!0)):o.uncommittedSyncedTransactions.push(a),o),{committedSyncedTransactions:[],uncommittedSyncedTransactions:[],hasTruncateSync:!1});if(!t||i){this.isCommittingSyncTransactions=!0;const o=new Set;for(const u of s)for(const d of u.operations)o.add(d.key);let a=this.preSyncVisibleState;if(a.size===0){a=new Map;for(const u of o){const d=this.get(u);d!==void 0&&a.set(u,d)}}const c=[],l=this.config.sync.rowUpdateMode||"partial";for(const u of s){if(u.truncate){for(const d of this.syncedData.keys()){if(this.optimisticDeletes.has(d))continue;const f=this.optimisticUpserts.get(d)||this.syncedData.get(d);f!==void 0&&c.push({type:"delete",key:d,value:f})}this.syncedData.clear(),this.syncedMetadata.clear(),this.syncedKeys.clear()}for(const d of u.operations){const f=d.key;switch(this.syncedKeys.add(f),d.type){case"insert":this.syncedMetadata.set(f,d.metadata);break;case"update":this.syncedMetadata.set(f,Object.assign({},this.syncedMetadata.get(f),d.metadata));break;case"delete":this.syncedMetadata.delete(f);break}switch(d.type){case"insert":this.syncedData.set(f,d.value);break;case"update":{if(l==="partial"){const p=Object.assign({},this.syncedData.get(f),d.value);this.syncedData.set(f,p)}else this.syncedData.set(f,d.value);break}case"delete":this.syncedData.delete(f);break}}}if(i){const u=new Set;for(const p of s)for(const g of p.operations)(g.type==="insert"||g.type==="update")&&u.add(g.key);const d=new Map,f=new Set;for(const p of this.transactions.values())if(!["completed","failed"].includes(p.state))for(const g of p.mutations){if(g.collection!==this||!g.optimistic)continue;const y=g.key;switch(g.type){case"insert":d.set(y,g.modified),f.delete(y);break;case"update":{const C=this.syncedData.get(y),v=C?Object.assign({},C,g.changes):g.modified;d.set(y,v),f.delete(y);break}case"delete":d.delete(y),f.add(y);break}}for(const[p,g]of d)if(!f.has(p))if(u.has(p)){let y=!1;for(let C=c.length-1;C>=0;C--){const v=c[C];if(v.key===p&&v.type==="insert"){v.value=g,y=!0;break}}y||c.push({type:"insert",key:p,value:g})}else c.push({type:"insert",key:p,value:g});if(c.length>0&&f.size>0){const p=[];for(const g of c)g.type==="insert"&&f.has(g.key)||p.push(g);c.length=0,c.push(...p)}this.isReady()||this.setStatus("ready")}this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this.isCommittingSyncTransactions=!1;for(const u of this.transactions.values())if(!["completed","failed"].includes(u.state)){for(const d of u.mutations)if(d.collection===this&&d.optimistic)switch(d.type){case"insert":case"update":this.optimisticUpserts.set(d.key,d.modified),this.optimisticDeletes.delete(d.key);break;case"delete":this.optimisticUpserts.delete(d.key),this.optimisticDeletes.add(d.key);break}}const h=new Map;for(const u of this.transactions.values())if(u.state==="completed")for(const d of u.mutations)d.collection===this&&o.has(d.key)&&h.set(d.key,{type:d.type,value:d.modified});for(const u of o){const d=a.get(u),f=this.get(u),p=h.get(u);p&&f!==void 0&&ue(p.value,f)||(d===void 0&&f!==void 0?c.push({type:"insert",key:u,value:f}):d!==void 0&&f===void 0?c.push({type:"delete",key:u,value:d}):d!==void 0&&f!==void 0&&!ue(d,f)&&c.push({type:"update",key:u,value:f,previousValue:d}))}if(this._size=this.calculateSize(),c.length>0&&this.updateIndexes(c),this.emitEvents(c,!0),this.pendingSyncedTransactions=r,this.preSyncVisibleState.clear(),Promise.resolve().then(()=>{this.recentlySyncedKeys.clear()}),!this.hasReceivedFirstCommit){this.hasReceivedFirstCommit=!0;const u=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],u.forEach(d=>d())}}},this.insert=(t,s)=>{this.validateCollectionUsable("insert");const r=Et();if(!r&&!this.config.onInsert)throw new mr;const i=Array.isArray(t)?t:[t],o=[];if(i.forEach(a=>{var c,l;const h=this.validateData(a,"insert"),u=this.getKeyFromItem(h);if(this.has(u))throw new lr(u);const d=this.generateGlobalKey(u,a),f={mutationId:crypto.randomUUID(),original:{},modified:h,changes:Object.fromEntries(Object.keys(a).map(p=>[p,h[p]])),globalKey:d,key:u,metadata:s?.metadata,syncMetadata:((l=(c=this.config.sync).getSyncMetadata)==null?void 0:l.call(c))||{},optimistic:s?.optimistic??!0,type:"insert",createdAt:new Date,updatedAt:new Date,collection:this};o.push(f)}),r)return r.applyMutations(o),this.transactions.set(r.id,r),this.scheduleTransactionCleanup(r),this.recomputeOptimisticState(!0),r;{const a=Be({mutationFn:async c=>await this.config.onInsert({transaction:c.transaction,collection:this})});return a.applyMutations(o),a.commit(),this.transactions.set(a.id,a),this.scheduleTransactionCleanup(a),this.recomputeOptimisticState(!0),a}},this.delete=(t,s)=>{this.validateCollectionUsable("delete");const r=Et();if(!r&&!this.config.onDelete)throw new wr;if(Array.isArray(t)&&t.length===0)throw new gr;const i=Array.isArray(t)?t:[t],o=[];for(const c of i){if(!this.has(c))throw new yr(c);const l=this.generateGlobalKey(c,this.get(c)),h={mutationId:crypto.randomUUID(),original:this.get(c),modified:this.get(c),changes:this.get(c),globalKey:l,key:c,metadata:s?.metadata,syncMetadata:this.syncedMetadata.get(c)||{},optimistic:s?.optimistic??!0,type:"delete",createdAt:new Date,updatedAt:new Date,collection:this};o.push(h)}if(r)return r.applyMutations(o),this.transactions.set(r.id,r),this.scheduleTransactionCleanup(r),this.recomputeOptimisticState(!0),r;const a=Be({autoCommit:!0,mutationFn:async c=>this.config.onDelete({transaction:c.transaction,collection:this})});return a.applyMutations(o),a.commit(),this.transactions.set(a.id,a),this.scheduleTransactionCleanup(a),this.recomputeOptimisticState(!0),a},!e)throw new tr;if(e.id?this.id=e.id:this.id=crypto.randomUUID(),!e.sync)throw new nr;this.transactions=new un((t,s)=>t.compareCreatedAt(s)),this.config={...e,autoIndex:e.autoIndex??"eager"},this.config.compare?this.syncedData=new un(this.config.compare):this.syncedData=new Map,e.startSync===!0&&this.startSync()}onFirstReady(e){if(this.hasBeenReady){e();return}this.onFirstReadyCallbacks.push(e)}isReady(){return this._status==="ready"}markReady(){if((this._status==="loading"||this._status==="initialCommit")&&(this.setStatus("ready"),!this.hasBeenReady)){this.hasBeenReady=!0,this.hasReceivedFirstCommit||(this.hasReceivedFirstCommit=!0);const e=[...this.onFirstReadyCallbacks];this.onFirstReadyCallbacks=[],e.forEach(t=>t()),this.changeListeners.size>0&&this.emitEmptyReadyEvent()}}get status(){return this._status}validateCollectionUsable(e){switch(this._status){case"error":throw new rr(e,this.id);case"cleaned-up":this.startSync();break}}validateStatusTransition(e,t){if(e===t)return;if(!{idle:["loading","error","cleaned-up"],loading:["initialCommit","ready","error","cleaned-up"],initialCommit:["ready","error","cleaned-up"],ready:["cleaned-up","error"],error:["cleaned-up","idle"],"cleaned-up":["loading","error"]}[e].includes(t))throw new ir(e,t,this.id)}setStatus(e){this.validateStatusTransition(this._status,e),this._status=e,e==="ready"&&!this.isIndexesResolved&&this.resolveAllIndexes().catch(t=>{console.warn("Failed to resolve indexes:",t)})}startSyncImmediate(){this.startSync()}startSync(){if(!(this._status!=="idle"&&this._status!=="cleaned-up")){this.setStatus("loading");try{const e=this.config.sync.sync({collection:this,begin:()=>{this.pendingSyncedTransactions.push({committed:!1,operations:[],deletedKeys:new Set})},write:t=>{const s=this.pendingSyncedTransactions[this.pendingSyncedTransactions.length-1];if(!s)throw new mn;if(s.committed)throw new vn;const r=this.getKeyFromItem(t.value);if(t.type==="insert"){const o=this.syncedData.has(r),a=s.deletedKeys.has(r),c=s.truncate===!0;if(o&&!a&&!c)throw new ur(r,this.id)}const i={...t,key:r};s.operations.push(i),t.type==="delete"&&s.deletedKeys.add(r)},commit:()=>{const t=this.pendingSyncedTransactions[this.pendingSyncedTransactions.length-1];if(!t)throw new kr;if(t.committed)throw new Ir;t.committed=!0,this._status==="loading"&&this.setStatus("initialCommit"),this.commitPendingTransactions()},markReady:()=>{this.markReady()},truncate:()=>{const t=this.pendingSyncedTransactions[this.pendingSyncedTransactions.length-1];if(!t)throw new mn;if(t.committed)throw new vn;t.operations=[],t.deletedKeys.clear(),t.truncate=!0}});this.syncCleanupFn=typeof e=="function"?e:null}catch(e){throw this.setStatus("error"),e}}}preload(){return this.preloadPromise?this.preloadPromise:(this.preloadPromise=new Promise((e,t)=>{if(this._status==="ready"){e();return}if(this._status==="error"){t(new or);return}if(this.onFirstReady(()=>{e()}),this._status==="idle"||this._status==="cleaned-up")try{this.startSync()}catch(s){t(s);return}}),this.preloadPromise)}async cleanup(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null);try{this.syncCleanupFn&&(this.syncCleanupFn(),this.syncCleanupFn=null)}catch(e){queueMicrotask(()=>{if(e instanceof Error){const t=new xn(this.id,e);throw t.cause=e,t.stack=e.stack,t}else throw new xn(this.id,e)})}return this.syncedData.clear(),this.syncedMetadata.clear(),this.optimisticUpserts.clear(),this.optimisticDeletes.clear(),this._size=0,this.pendingSyncedTransactions=[],this.syncedKeys.clear(),this.hasReceivedFirstCommit=!1,this.hasBeenReady=!1,this.onFirstReadyCallbacks=[],this.preloadPromise=null,this.batchedEvents=[],this.shouldBatchEvents=!1,this.setStatus("cleaned-up"),Promise.resolve()}startGCTimer(){this.gcTimeoutId&&clearTimeout(this.gcTimeoutId);const e=this.config.gcTime??3e5;e!==0&&(this.gcTimeoutId=setTimeout(()=>{this.activeSubscribersCount===0&&this.cleanup()},e))}cancelGCTimer(){this.gcTimeoutId&&(clearTimeout(this.gcTimeoutId),this.gcTimeoutId=null)}addSubscriber(){this.activeSubscribersCount++,this.cancelGCTimer(),(this._status==="cleaned-up"||this._status==="idle")&&this.startSync()}removeSubscriber(){if(this.activeSubscribersCount--,this.activeSubscribersCount===0)this.startGCTimer();else if(this.activeSubscribersCount<0)throw new ar}recomputeOptimisticState(e=!1){if(this.isCommittingSyncTransactions)return;const t=new Map(this.optimisticUpserts),s=new Set(this.optimisticDeletes);this.optimisticUpserts.clear(),this.optimisticDeletes.clear();const r=[];for(const a of this.transactions.values())["completed","failed"].includes(a.state)||r.push(a);for(const a of r)for(const c of a.mutations)if(c.collection===this&&c.optimistic)switch(c.type){case"insert":case"update":this.optimisticUpserts.set(c.key,c.modified),this.optimisticDeletes.delete(c.key);break;case"delete":this.optimisticUpserts.delete(c.key),this.optimisticDeletes.add(c.key);break}this._size=this.calculateSize();const i=[];this.collectOptimisticChanges(t,s,i);const o=i.filter(a=>!!(!this.recentlySyncedKeys.has(a.key)||e));if(this.pendingSyncedTransactions.length>0&&!e){const a=new Set;for(const l of this.pendingSyncedTransactions)for(const h of l.operations)a.add(h.key);const c=o.filter(l=>!(l.type==="delete"&&a.has(l.key)&&!r.some(u=>u.mutations.some(d=>d.collection===this&&d.key===l.key))));c.length>0&&this.updateIndexes(c),this.emitEvents(c,e)}else o.length>0&&this.updateIndexes(o),this.emitEvents(o,e)}calculateSize(){const e=this.syncedData.size,t=Array.from(this.optimisticDeletes).filter(r=>this.syncedData.has(r)&&!this.optimisticUpserts.has(r)).length,s=Array.from(this.optimisticUpserts.keys()).filter(r=>!this.syncedData.has(r)).length;return e-t+s}collectOptimisticChanges(e,t,s){const r=new Set([...e.keys(),...this.optimisticUpserts.keys(),...t,...this.optimisticDeletes]);for(const i of r){const o=this.get(i),a=this.getPreviousValue(i,e,t);a!==void 0&&o===void 0?s.push({type:"delete",key:i,value:a}):a===void 0&&o!==void 0?s.push({type:"insert",key:i,value:o}):a!==void 0&&o!==void 0&&a!==o&&s.push({type:"update",key:i,value:o,previousValue:a})}}getPreviousValue(e,t,s){if(!s.has(e))return t.has(e)?t.get(e):this.syncedData.get(e)}emitEmptyReadyEvent(){for(const e of this.changeListeners)e([]);for(const[e,t]of this.changeKeyListeners)for(const s of t)s([])}emitEvents(e,t=!1){if(this.shouldBatchEvents&&!t){this.batchedEvents.push(...e);return}let s=e;if(this.batchedEvents.length>0&&t&&(s=[...this.batchedEvents,...e],this.batchedEvents=[],this.shouldBatchEvents=!1),s.length!==0){for(const r of this.changeListeners)r(s);if(this.changeKeyListeners.size>0){const r=new Map;for(const i of s)this.changeKeyListeners.has(i.key)&&(r.has(i.key)||r.set(i.key,[]),r.get(i.key).push(i));for(const[i,o]of r){const a=this.changeKeyListeners.get(i);for(const c of a)c(o)}}}}get(e){if(!this.optimisticDeletes.has(e))return this.optimisticUpserts.has(e)?this.optimisticUpserts.get(e):this.syncedData.get(e)}has(e){return this.optimisticDeletes.has(e)?!1:this.optimisticUpserts.has(e)?!0:this.syncedData.has(e)}get size(){return this._size}*keys(){for(const e of this.syncedData.keys())this.optimisticDeletes.has(e)||(yield e);for(const e of this.optimisticUpserts.keys())!this.syncedData.has(e)&&!this.optimisticDeletes.has(e)&&(yield e)}*values(){for(const e of this.keys()){const t=this.get(e);t!==void 0&&(yield t)}}*entries(){for(const e of this.keys()){const t=this.get(e);t!==void 0&&(yield[e,t])}}*[Symbol.iterator](){for(const[e,t]of this.entries())yield[e,t]}forEach(e){let t=0;for(const[s,r]of this.entries())e(r,s,t++)}map(e){const t=[];let s=0;for(const[r,i]of this.entries())t.push(e(i,r,s++));return t}scheduleTransactionCleanup(e){if(e.state==="completed"){this.transactions.delete(e.id);return}e.isPersisted.promise.then(()=>{this.transactions.delete(e.id)}).catch(()=>{})}ensureStandardSchema(e){if(e&&"~standard"in e)return e;throw new sr}getKeyFromItem(e){return this.config.getKey(e)}generateGlobalKey(e,t){if(typeof e>"u")throw new cr(t);return`KEY::${this.id}/${e}`}createIndex(e,t={}){this.validateCollectionUsable("createIndex");const s=++this.indexCounter,r=jt(),i=e(r),o=B(i),a=t.indexType??$t,c=new ei(s,o,t.name,a,t.options,this.entries());if(this.lazyIndexes.set(s,c),a===$t)try{const l=c.getResolved();this.resolvedIndexes.set(s,l)}catch(l){console.warn("Failed to resolve BTreeIndex:",l)}else if(typeof a=="function"&&a.prototype)try{const l=c.getResolved();this.resolvedIndexes.set(s,l)}catch{this.resolveSingleIndex(s,c).catch(l=>{console.warn("Failed to resolve single index:",l)})}else this.isIndexesResolved&&this.resolveSingleIndex(s,c).catch(l=>{console.warn("Failed to resolve single index:",l)});return new ti(s,c)}async resolveAllIndexes(){if(this.isIndexesResolved)return;const e=Array.from(this.lazyIndexes.entries()).map(async([t,s])=>{const r=await s.resolve();return r.build(this.entries()),this.resolvedIndexes.set(t,r),{indexId:t,resolvedIndex:r}});await Promise.all(e),this.isIndexesResolved=!0}async resolveSingleIndex(e,t){const s=await t.resolve();return s.build(this.entries()),this.resolvedIndexes.set(e,s),s}get indexes(){return this.resolvedIndexes}updateIndexes(e){for(const t of this.resolvedIndexes.values())for(const s of e)switch(s.type){case"insert":t.add(s.key,s.value);break;case"update":s.previousValue?t.update(s.key,s.previousValue,s.value):t.add(s.key,s.value);break;case"delete":t.remove(s.key,s.value);break}}validateData(e,t,s){if(!this.config.schema)return e;const r=this.ensureStandardSchema(this.config.schema);if(t==="update"&&s){const o=this.get(s);if(o&&e&&typeof e=="object"&&typeof o=="object"){const a=Object.assign({},o,e),c=r["~standard"].validate(a);if(c instanceof Promise)throw new yn;if("issues"in c&&c.issues){const l=c.issues.map(h=>{var u;return{message:h.message,path:(u=h.path)==null?void 0:u.map(d=>String(d))}});throw new gn(t,l)}return e}}const i=r["~standard"].validate(e);if(i instanceof Promise)throw new yn;if("issues"in i&&i.issues){const o=i.issues.map(a=>{var c;return{message:a.message,path:(c=a.path)==null?void 0:c.map(l=>String(l))}});throw new gn(t,o)}return i.value}update(e,t,s){if(typeof e>"u")throw new hr;this.validateCollectionUsable("update");const r=Et();if(!r&&!this.config.onUpdate)throw new vr;const i=Array.isArray(e),o=i?e:[e];if(i&&o.length===0)throw new fr;const a=typeof t=="function"?t:s,c=typeof t=="function"?{}:t,l=o.map(f=>{const p=this.get(f);if(!p)throw new dr(f);return p});let h;i?h=Gs(l,a):h=[Js(l[0],a)];const u=o.map((f,p)=>{const g=h[p];if(!g||Object.keys(g).length===0)return null;const y=l[p],C=this.validateData(g,"update",f),v=Object.assign({},y,C),E=this.getKeyFromItem(y),S=this.getKeyFromItem(v);if(E!==S)throw new pr(E,S);const m=this.generateGlobalKey(S,v);return{mutationId:crypto.randomUUID(),original:y,modified:v,changes:C,globalKey:m,key:f,metadata:c.metadata,syncMetadata:this.syncedMetadata.get(f)||{},optimistic:c.optimistic??!0,type:"update",createdAt:new Date,updatedAt:new Date,collection:this}}).filter(Boolean);if(u.length===0){const f=Be({mutationFn:async()=>{}});return f.commit(),this.scheduleTransactionCleanup(f),f}if(r)return r.applyMutations(u),this.transactions.set(r.id,r),this.scheduleTransactionCleanup(r),this.recomputeOptimisticState(!0),r;const d=Be({mutationFn:async f=>this.config.onUpdate({transaction:f.transaction,collection:this})});return d.applyMutations(u),d.commit(),this.transactions.set(d.id,d),this.scheduleTransactionCleanup(d),this.recomputeOptimisticState(!0),d}get state(){const e=new Map;for(const[t,s]of this.entries())e.set(t,s);return e}stateWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.state):new Promise(e=>{this.onFirstReady(()=>{e(this.state)})})}get toArray(){return Array.from(this.values())}toArrayWhenReady(){return this.size>0||this.isReady()?Promise.resolve(this.toArray):new Promise(e=>{this.onFirstReady(()=>{e(this.toArray)})})}currentStateAsChanges(e={}){return vi(this,e)}subscribeChanges(e,t={}){this.addSubscriber(),t.whereExpression&&ni(t.whereExpression,this);const s=t.where||t.whereExpression?wi(e,t):e;if(t.includeInitialState){const r=this.currentStateAsChanges({where:t.where,whereExpression:t.whereExpression});s(r)}return this.changeListeners.add(s),()=>{this.changeListeners.delete(s),this.removeSubscriber()}}subscribeChangesKey(e,t,{includeInitialState:s=!1}={}){return this.addSubscriber(),this.changeKeyListeners.has(e)||this.changeKeyListeners.set(e,new Set),s&&t([{type:"insert",key:e,value:this.get(e)}]),this.changeKeyListeners.get(e).add(t),()=>{const r=this.changeKeyListeners.get(e);r&&(r.delete(t),r.size===0&&this.changeKeyListeners.delete(e)),this.removeSubscriber()}}capturePreSyncVisibleState(){if(this.pendingSyncedTransactions.length===0)return;this.preSyncVisibleState.clear();const e=new Set;for(const t of this.pendingSyncedTransactions)for(const s of t.operations)e.add(s.key);for(const t of e)this.recentlySyncedKeys.add(t);for(const t of e){const s=this.get(t);s!==void 0&&this.preSyncVisibleState.set(t,s)}}onTransactionStateChange(){this.shouldBatchEvents=this.pendingSyncedTransactions.length>0,this.capturePreSyncVisibleState(),this.recomputeOptimisticState(!1)}}class M{constructor(e={}){this.query={},this.query={...e}}_createRefForSource(e,t){if(Object.keys(e).length!==1)throw new Er(t);const s=Object.keys(e)[0],r=e[s];let i;if(r instanceof Qn)i=new we(r,s);else if(r instanceof M){const o=r._getQuery();if(!o.from)throw new br(t);i=new L(o,s)}else throw new Rr(s);return[s,i]}from(e){const[,t]=this._createRefForSource(e,"from clause");return new M({...this.query,from:t})}join(e,t,s="left"){const[r,i]=this._createRefForSource(e,"join clause"),a=[...this._getCurrentAliases(),r],c=he(a),l=t(c);let h,u;if(l.type==="func"&&l.name==="eq"&&l.args.length===2)h=l.args[0],u=l.args[1];else throw new Or;const d={from:i,type:s,left:h,right:u},f=this.query.join||[];return new M({...this.query,join:[...f,d]})}leftJoin(e,t){return this.join(e,t,"left")}rightJoin(e,t){return this.join(e,t,"right")}innerJoin(e,t){return this.join(e,t,"inner")}fullJoin(e,t){return this.join(e,t,"full")}where(e){const t=this._getCurrentAliases(),s=he(t),r=e(s),i=this.query.where||[];return new M({...this.query,where:[...i,r]})}having(e){const t=this._getCurrentAliases(),s=he(t),r=e(s),i=this.query.having||[];return new M({...this.query,having:[...i,r]})}select(e){const t=this._getCurrentAliases(),s=he(t),r=e(s),i=s.__spreadSentinels,o={};for(const a of i){const c=`__SPREAD_SENTINEL__${a}`;o[c]=B(a)}for(const[a,c]of Object.entries(r))Gn(c)?o[a]=B(c):typeof c=="object"&&"type"in c&&(c.type==="agg"||c.type==="func")?o[a]=c:o[a]=B(c);return new M({...this.query,select:o,fnSelect:void 0})}orderBy(e,t="asc"){const s=this._getCurrentAliases(),r=he(s),i=e(r),o=typeof t=="string"?{direction:t,nulls:"first",stringSort:"locale"}:{direction:t.direction??"asc",nulls:t.nulls??"first",stringSort:t.stringSort??"locale",locale:t.stringSort==="locale"?t.locale:void 0,localeOptions:t.stringSort==="locale"?t.localeOptions:void 0},a=h=>({expression:B(h),compareOptions:o}),c=Array.isArray(i)?i.map(h=>a(h)):[a(i)],l=this.query.orderBy||[];return new M({...this.query,orderBy:[...l,...c]})}groupBy(e){const t=this._getCurrentAliases(),s=he(t),r=e(s),i=Array.isArray(r)?r.map(o=>B(o)):[B(r)];return new M({...this.query,groupBy:i})}limit(e){return new M({...this.query,limit:e})}offset(e){return new M({...this.query,offset:e})}distinct(){return new M({...this.query,distinct:!0})}_getCurrentAliases(){const e=[];if(this.query.from&&e.push(this.query.from.alias),this.query.join)for(const t of this.query.join)e.push(t.from.alias);return e}get fn(){const e=this;return{select(t){return new M({...e.query,select:void 0,fnSelect:t})},where(t){return new M({...e.query,fnWhere:[...e.query.fnWhere||[],t]})},having(t){return new M({...e.query,fnHaving:[...e.query.fnHaving||[],t]})}}}_getQuery(){if(!this.query.from)throw new Mr;return this.query}}function _i(n){const e=n(new M);return Zn(e)}function Zn(n){return n._getQuery()}var _e={exports:{}},bt={exports:{}},Sn;function Si(){return Sn||(Sn=1,(function(n){function e(t,s){var r,i,o,a,c,l,h,u;for(r=t.length&3,i=t.length-r,o=s,c=3432918353,l=461845907,u=0;u<i;)h=t.charCodeAt(u)&255|(t.charCodeAt(++u)&255)<<8|(t.charCodeAt(++u)&255)<<16|(t.charCodeAt(++u)&255)<<24,++u,h=(h&65535)*c+(((h>>>16)*c&65535)<<16)&4294967295,h=h<<15|h>>>17,h=(h&65535)*l+(((h>>>16)*l&65535)<<16)&4294967295,o^=h,o=o<<13|o>>>19,a=(o&65535)*5+(((o>>>16)*5&65535)<<16)&4294967295,o=(a&65535)+27492+(((a>>>16)+58964&65535)<<16);switch(h=0,r){case 3:h^=(t.charCodeAt(u+2)&255)<<16;case 2:h^=(t.charCodeAt(u+1)&255)<<8;case 1:h^=t.charCodeAt(u)&255,h=(h&65535)*c+(((h>>>16)*c&65535)<<16)&4294967295,h=h<<15|h>>>17,h=(h&65535)*l+(((h>>>16)*l&65535)<<16)&4294967295,o^=h}return o^=t.length,o^=o>>>16,o=(o&65535)*2246822507+(((o>>>16)*2246822507&65535)<<16)&4294967295,o^=o>>>13,o=(o&65535)*3266489909+(((o>>>16)*3266489909&65535)<<16)&4294967295,o^=o>>>16,o>>>0}n.exports=e})(bt)),bt.exports}var Rt={exports:{}},Cn;function Ci(){return Cn||(Cn=1,(function(n){function e(t,s){for(var r=t.length,i=s^r,o=0,a;r>=4;)a=t.charCodeAt(o)&255|(t.charCodeAt(++o)&255)<<8|(t.charCodeAt(++o)&255)<<16|(t.charCodeAt(++o)&255)<<24,a=(a&65535)*1540483477+(((a>>>16)*1540483477&65535)<<16),a^=a>>>24,a=(a&65535)*1540483477+(((a>>>16)*1540483477&65535)<<16),i=(i&65535)*1540483477+(((i>>>16)*1540483477&65535)<<16)^a,r-=4,++o;switch(r){case 3:i^=(t.charCodeAt(o+2)&255)<<16;case 2:i^=(t.charCodeAt(o+1)&255)<<8;case 1:i^=t.charCodeAt(o)&255,i=(i&65535)*1540483477+(((i>>>16)*1540483477&65535)<<16)}return i^=i>>>13,i=(i&65535)*1540483477+(((i>>>16)*1540483477&65535)<<16),i^=i>>>15,i>>>0}n.exports=e})(Rt)),Rt.exports}var kn;function ki(){if(kn)return _e.exports;kn=1;var n=Si(),e=Ci();return _e.exports=n,_e.exports.murmur3=n,_e.exports.murmur2=e,_e.exports}var Ii=ki();const In=Bs(Ii);class Xn extends Map{constructor(e,t){super(t),this.defaultValue=e}get(e){return this.has(e)||this.set(e,this.defaultValue()),super.get(e)}update(e,t){const s=this.get(e),r=t(s);return this.set(e,r),r}}const Ot=3e4;function Mt(n,e){if(e.length<=Ot)n.push(...e);else for(let t=0;t<e.length;t+=Ot){const s=e.slice(t,t+Ot);n.push(...s)}}const Tt=new WeakMap;function lt(n,e){return typeof e=="bigint"||typeof e=="symbol"||typeof e=="function"?String(e):e===void 0?"undefined":e instanceof Map?`Map(${JSON.stringify(Array.from(e.entries()),lt)})`:e instanceof Set?`Set(${JSON.stringify(Array.from(e.values()),lt)})`:e}function es(n){if(n==null||typeof n!="object"&&typeof n!="function"){const s=JSON.stringify(n,lt);return In.murmur3(s).toString(16)}if(Tt.has(n))return Tt.get(n);const e=JSON.stringify(n,lt),t=In.murmur3(e).toString(16);return Tt.set(n,t),t}function Ei(n,e,t){let s=0,r=n.length;for(;s<r;){const i=Math.floor((s+r)/2),o=t(n[i],e);if(o<0)s=i+1;else if(o>0)r=i;else return i}return s}class bi{constructor(){this.objectIds=new WeakMap,this.nextId=0}getId(e){if(typeof e!="object"||e===null){const t=String(e);let s=0;for(let r=0;r<t.length;r++){const i=t.charCodeAt(r);s=(s<<5)-s+i,s=s&s}return s}return this.objectIds.has(e)||this.objectIds.set(e,this.nextId++),this.objectIds.get(e)}getStringId(e){return e===null?"null":e===void 0?"undefined":typeof e!="object"?`str_${String(e)}`:`obj_${this.getId(e)}`}}const je=new bi;var ts=n=>{throw TypeError(n)},Xt=(n,e,t)=>e.has(n)||ts("Cannot "+t),$=(n,e,t)=>(Xt(n,e,"read from private field"),t?t.call(n):e.get(n)),En=(n,e,t)=>e.has(n)?ts("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Ri=(n,e,t,s)=>(Xt(n,e,"write to private field"),e.set(n,t),t),ut=(n,e,t)=>(Xt(n,e,"access private method"),t),T,ve,ns,ht;const en=class oe{constructor(e=[]){En(this,ve),En(this,T),Ri(this,T,e)}toString(e=!1){return`MultiSet(${JSON.stringify($(this,T),null,e?2:void 0)})`}toJSON(){return JSON.stringify(Array.from(this.getInner()))}static fromJSON(e){return new oe(JSON.parse(e))}map(e){return new oe($(this,T).map(([t,s])=>[e(t),s]))}filter(e){return new oe($(this,T).filter(([t,s])=>e(t)))}negate(){return new oe($(this,T).map(([e,t])=>[e,-t]))}concat(e){const t=[];return Mt(t,$(this,T)),Mt(t,e.getInner()),new oe(t)}consolidate(){var e;if($(this,T).length>0){const t=(e=$(this,T)[0])==null?void 0:e[0];if(Array.isArray(t)&&t.length===2)return ut(this,ve,ns).call(this)}return ut(this,ve,ht).call(this)}extend(e){const t=e instanceof oe?e.getInner():e;Mt($(this,T),t)}getInner(){return $(this,T)}};T=new WeakMap;ve=new WeakSet;ns=function(){const n=new Map,e=new Map,t=r=>{if(r.length!==2)throw new Error("Expected tuple of length 2");const[i,o]=r;return`${je.getStringId(i)}|${je.getStringId(o)}`};for(const[r,i]of $(this,T)){if(!Array.isArray(r)||r.length!==2)return ut(this,ve,ht).call(this);const[o,a]=r;if(typeof o!="string"&&typeof o!="number")return ut(this,ve,ht).call(this);let c;Array.isArray(a)&&a.length===2?c=t(a):c=je.getStringId(a);const l=o+"|"+c;n.set(l,(n.get(l)||0)+i),e.has(l)||e.set(l,r)}const s=[];for(const[r,i]of n)i!==0&&s.push([e.get(r),i]);return new en(s)};ht=function(){const n=new Xn(()=>0),e=new Map;let t=!1,s=!1,r=!1;for(const[a,c]of $(this,T))if(typeof a=="string")t=!0;else if(typeof a=="number")s=!0;else{r=!0;break}const i=r||t&&s;for(const[a,c]of $(this,T)){const l=i?es(a):a;i&&!e.has(l)&&e.set(l,a),n.update(l,h=>h+c)}const o=[];for(const[a,c]of n.entries())if(c!==0){const l=i?e.get(a):a;o.push([l,c])}return new en(o)};let Q=en;var ss=n=>{throw TypeError(n)},rs=(n,e,t)=>e.has(n)||ss("Cannot "+t),Re=(n,e,t)=>(rs(n,e,"read from private field"),t?t.call(n):e.get(n)),is=(n,e,t)=>e.has(n)?ss("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Oi=(n,e,t,s)=>(rs(n,e,"write to private field"),e.set(n,t),t),fe,Je;class Mi{constructor(e){is(this,fe),Oi(this,fe,e)}drain(){const e=[...Re(this,fe)].reverse();return Re(this,fe).length=0,e}isEmpty(){return Re(this,fe).length===0}}fe=new WeakMap;class D{constructor(){is(this,Je,[])}sendData(e){e instanceof Q||(e=new Q(e));for(const t of Re(this,Je))t.unshift(e)}newReader(){const e=[];return Re(this,Je).push(e),new Mi(e)}}Je=new WeakMap;class os{constructor(e,t,s){this.id=e,this.inputs=t,this.output=s}hasPendingWork(){return this.inputs.some(e=>!e.isEmpty())}}class xe extends os{constructor(e,t,s){super(e,[t],s),this.id=e}inputMessages(){return this.inputs[0].drain()}}class as extends os{constructor(e,t,s,r){super(e,[t,s],r),this.id=e}inputAMessages(){return this.inputs[0].drain()}inputBMessages(){return this.inputs[1].drain()}}class Ct extends xe{run(){for(const e of this.inputMessages())this.output.sendData(this.inner(e))}}var cs=n=>{throw TypeError(n)},tn=(n,e,t)=>e.has(n)||cs("Cannot "+t),V=(n,e,t)=>(tn(n,e,"read from private field"),t?t.call(n):e.get(n)),le=(n,e,t)=>e.has(n)?cs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ft=(n,e,t,s)=>(tn(n,e,"write to private field"),e.set(n,t),t),Se=(n,e,t)=>(tn(n,e,"access private method"),t),Ti=(n,e,t,s)=>({set _(r){ft(n,e,r)},get _(){return V(n,e,s)}}),Ge,ke,Dt,Oe,ae,de,He,Ie;class Ai{constructor(){le(this,ae),le(this,Ge,[]),le(this,ke,[]),le(this,Dt,0),le(this,Oe,!1)}getNextOperatorId(){return Se(this,ae,de).call(this),Ti(this,Dt)._++}newInput(){Se(this,ae,de).call(this);const e=new D,t=new Pi(this,e);return V(this,Ge).push(t.connectReader()),t}addOperator(e){Se(this,ae,de).call(this),V(this,ke).push(e)}addStream(e){Se(this,ae,de).call(this),V(this,Ge).push(e)}finalize(){Se(this,ae,de).call(this),ft(this,Oe,!0)}step(){if(!V(this,Oe))throw new Error("Graph not finalized");for(const e of V(this,ke))e.run()}pendingWork(){return V(this,ke).some(e=>e.hasPendingWork())}run(){for(;this.pendingWork();)this.step()}}Ge=new WeakMap;ke=new WeakMap;Dt=new WeakMap;Oe=new WeakMap;ae=new WeakSet;de=function(){if(V(this,Oe))throw new Error("Graph already finalized")};class N{constructor(e,t){le(this,He),le(this,Ie),ft(this,He,e),ft(this,Ie,t)}connectReader(){return V(this,Ie).newReader()}get writer(){return V(this,Ie)}get graph(){return V(this,He)}pipe(...e){return e.reduce((t,s)=>s(t),this)}}He=new WeakMap;Ie=new WeakMap;class Pi extends N{sendData(e){this.writer.sendData(e)}}var ls=n=>{throw TypeError(n)},us=(n,e,t)=>e.has(n)||ls("Cannot "+t),Ki=(n,e,t)=>(us(n,e,"read from private field"),t?t.call(n):e.get(n)),zi=(n,e,t)=>e.has(n)?ls("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),$i=(n,e,t,s)=>(us(n,e,"write to private field"),e.set(n,t),t),qe;class Fi extends Ct{constructor(e,t,s,r){super(e,t,s),zi(this,qe),$i(this,qe,r)}inner(e){return e.map(Ki(this,qe))}}qe=new WeakMap;function b(n){return e=>{const t=new N(e.graph,new D),s=new Fi(e.graph.getNextOperatorId(),e.connectReader(),t.writer,n);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}var hs=n=>{throw TypeError(n)},fs=(n,e,t)=>e.has(n)||hs("Cannot "+t),H=(n,e,t)=>(fs(n,e,"read from private field"),t?t.call(n):e.get(n)),Di=(n,e,t)=>e.has(n)?hs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Ni=(n,e,t,s)=>(fs(n,e,"write to private field"),e.set(n,t),t),z;class ye{constructor(){Di(this,z),Ni(this,z,new Xn(()=>new Map))}toString(e=!1){return`Index(${JSON.stringify([...H(this,z)].map(([t,s])=>[t,[...s]]),void 0,e?"  ":void 0)})`}get(e){return[...H(this,z).get(e).entries()]}getMultiplicity(e,t){return H(this,z).get(e).get(t)??0}entries(){return H(this,z).entries()}keys(){return H(this,z).keys()}has(e){return H(this,z).has(e)}get size(){return H(this,z).size}addValue(e,t){const[s,r]=t,i=H(this,z).get(e),a=(i.get(s)??0)+r;r!==0&&(a===0?i.delete(s):i.set(s,a))}append(e){for(const[t,s]of e.entries()){const r=H(this,z).get(t);for(const[i,o]of s.entries()){const c=(r.get(i)??0)+o;c===0?r.delete(i):r.set(i,c)}}}join(e){const t=[];if(this.size<=e.size)for(const[s,r]of this.entries()){if(!e.has(s))continue;const i=e.get(s);for(const[o,a]of r.entries())for(const[c,l]of i)a!==0&&l!==0&&t.push([[s,[o,c]],a*l])}else for(const[s,r]of e.entries()){if(!this.has(s))continue;const i=this.get(s);for(const[o,a]of r.entries())for(const[c,l]of i)l!==0&&a!==0&&t.push([[s,[c,o]],l*a])}return new Q(t)}}z=new WeakMap;var ds=n=>{throw TypeError(n)},ps=(n,e,t)=>e.has(n)||ds("Cannot "+t),ie=(n,e,t)=>(ps(n,e,"read from private field"),t?t.call(n):e.get(n)),At=(n,e,t)=>e.has(n)?ds("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Wi=(n,e,t,s)=>(ps(n,e,"write to private field"),e.set(n,t),t),Ye,pe,Qe;class Bi extends xe{constructor(e,t,s,r){super(e,t,s),At(this,Ye,new ye),At(this,pe,new ye),At(this,Qe),Wi(this,Qe,r)}run(){const e=new Set;for(const s of this.inputMessages())for(const[r,i]of s.getInner()){const[o,a]=r;ie(this,Ye).addValue(o,[a,i]),e.add(o)}const t=[];for(const s of e){const r=ie(this,Ye).get(s),i=ie(this,pe).get(s),o=ie(this,Qe).call(this,r),a=new Map,c=new Map;for(const[l,h]of o){const u=a.get(l)??0;a.set(l,u+h)}for(const[l,h]of i){const u=c.get(l)??0;c.set(l,u+h)}for(const[l,h]of c)a.has(l)||(t.push([[s,l],-h]),ie(this,pe).addValue(s,[l,-h]));for(const[l,h]of a)c.has(l)||h!==0&&(t.push([[s,l],h]),ie(this,pe).addValue(s,[l,h]));for(const[l,h]of a){const u=c.get(l);if(u!==void 0){const d=h-u;d!==0&&(t.push([[s,l],d]),ie(this,pe).addValue(s,[l,d]))}}}t.length>0&&this.output.sendData(new Q(t))}}Ye=new WeakMap;pe=new WeakMap;Qe=new WeakMap;function Vi(n){return e=>{const t=new N(e.graph,new D),s=new Bi(e.graph.getNextOperatorId(),e.connectReader(),t.writer,n);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}function bn(n){return"pipe"in n}function Rn(n,e={}){const t=Object.fromEntries(Object.entries(e).filter(([s,r])=>!bn(r)));return Object.fromEntries(Object.entries(e).filter(([s,r])=>bn(r))),s=>{const r="__original_key__";return s.pipe(b(a=>{const c=n(a),l=JSON.stringify(c),h={};h[r]=c;for(const[u,d]of Object.entries(t))h[u]=d.preMap(a);return[l,h]})).pipe(Vi(a=>{var c,l;let h=0;for(const[f,p]of a)h+=p;if(h<=0)return[];const u={},d=(l=(c=a[0])==null?void 0:c[0])==null?void 0:l[r];u[r]=d;for(const[f,p]of Object.entries(t)){const g=a.map(([y,C])=>[y[f],C]);u[f]=p.reduce(g)}return[[u,1]]})).pipe(b(([a,c])=>{const l=c[r],h={};Object.assign(h,l);for(const[u,d]of Object.entries(t))d.postMap?h[u]=d.postMap(c[u]):h[u]=c[u];return[a,h]}))}}function Li(n=e=>e){return{preMap:e=>n(e),reduce:e=>{let t=0;for(const[s,r]of e)t+=s*r;return t}}}function Ui(){return{preMap:()=>1,reduce:n=>{let e=0;for(const[t,s]of n)e+=s;return e}}}function ji(n=e=>e){return{preMap:e=>({sum:n(e),count:0}),reduce:e=>{let t=0,s=0;for(const[r,i]of e)t+=r.sum*i,s+=i;return{sum:t,count:s}},postMap:e=>e.sum/e.count}}function Ji(n=e=>e){return{preMap:e=>n(e),reduce:e=>{let t=Number.POSITIVE_INFINITY;for(const[s,r]of e)s<t&&(t=s);return t===Number.POSITIVE_INFINITY?0:t}}}function Gi(n=e=>e){return{preMap:e=>n(e),reduce:e=>{let t=Number.NEGATIVE_INFINITY;for(const[s,r]of e)s>t&&(t=s);return t===Number.NEGATIVE_INFINITY?0:t}}}const Hi={sum:Li,count:Ui,avg:ji,min:Ji,max:Gi};var gs=n=>{throw TypeError(n)},ys=(n,e,t)=>e.has(n)||gs("Cannot "+t),qi=(n,e,t)=>(ys(n,e,"read from private field"),t?t.call(n):e.get(n)),Yi=(n,e,t)=>e.has(n)?gs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Qi=(n,e,t,s)=>(ys(n,e,"write to private field"),e.set(n,t),t),Ze;class Zi extends Ct{constructor(e,t,s,r){super(e,t,s),Yi(this,Ze),Qi(this,Ze,r)}inner(e){return e.map(t=>(qi(this,Ze).call(this,t),t))}}Ze=new WeakMap;function Xi(n){return e=>{const t=new N(e.graph,new D),s=new Zi(e.graph.getNextOperatorId(),e.connectReader(),t.writer,n);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}var ms=n=>{throw TypeError(n)},vs=(n,e,t)=>e.has(n)||ms("Cannot "+t),eo=(n,e,t)=>(vs(n,e,"read from private field"),t?t.call(n):e.get(n)),to=(n,e,t)=>e.has(n)?ms("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),no=(n,e,t,s)=>(vs(n,e,"write to private field"),e.set(n,t),t),Xe;class so extends Ct{constructor(e,t,s,r){super(e,t,s),to(this,Xe),no(this,Xe,r)}inner(e){return e.filter(eo(this,Xe))}}Xe=new WeakMap;function ne(n){return e=>{const t=new N(e.graph,new D),s=new so(e.graph.getNextOperatorId(),e.connectReader(),t.writer,n);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}class ro extends Ct{inner(e){return e.negate()}}function io(){return n=>{const e=new N(n.graph,new D),t=new ro(n.graph.getNextOperatorId(),n.connectReader(),e.writer);return n.graph.addOperator(t),n.graph.addStream(e.connectReader()),e}}class oo extends as{run(){for(const e of this.inputAMessages())this.output.sendData(e);for(const e of this.inputBMessages())this.output.sendData(e)}}function Ke(n){return e=>{if(e.graph!==n.graph)throw new Error("Cannot concat streams from different graphs");const t=new N(e.graph,new D),s=new oo(e.graph.getNextOperatorId(),e.connectReader(),n.connectReader(),t.writer);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}var ws=n=>{throw TypeError(n)},xs=(n,e,t)=>e.has(n)||ws("Cannot "+t),ao=(n,e,t)=>(xs(n,e,"read from private field"),t?t.call(n):e.get(n)),co=(n,e,t)=>e.has(n)?ws("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),lo=(n,e,t,s)=>(xs(n,e,"write to private field"),e.set(n,t),t),et;class uo extends xe{constructor(e,t,s,r){super(e,t,s),co(this,et),lo(this,et,r)}run(){for(const e of this.inputMessages())ao(this,et).call(this,e),this.output.sendData(e)}}et=new WeakMap;function ho(n){return e=>{const t=new N(e.graph,new D),s=new uo(e.graph.getNextOperatorId(),e.connectReader(),t.writer,n);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}class fo extends xe{run(){const e=this.inputMessages();if(e.length===0)return;const t=new Q;for(const r of e)t.extend(r);const s=t.consolidate();s.getInner().length>0&&this.output.sendData(s)}}function _s(){return n=>{const e=new N(n.graph,new D),t=new fo(n.graph.getNextOperatorId(),n.connectReader(),e.writer);return n.graph.addOperator(t),n.graph.addStream(e.connectReader()),e}}var Ss=n=>{throw TypeError(n)},po=(n,e,t)=>e.has(n)||Ss("Cannot "+t),Ve=(n,e,t)=>(po(n,e,"read from private field"),t?t.call(n):e.get(n)),On=(n,e,t)=>e.has(n)?Ss("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),tt,nt;class go extends as{constructor(e,t,s,r){super(e,t,s,r),On(this,tt,new ye),On(this,nt,new ye)}run(){const e=new ye,t=new ye,s=this.inputAMessages();for(const o of s){const a=o;for(const[c,l]of a.getInner()){const[h,u]=c;e.addValue(h,[u,l])}}const r=this.inputBMessages();for(const o of r){const a=o;for(const[c,l]of a.getInner()){const[h,u]=c;t.addValue(h,[u,l])}}const i=new Q;i.extend(e.join(Ve(this,nt))),Ve(this,tt).append(e),i.extend(Ve(this,tt).join(t)),i.getInner().length>0&&this.output.sendData(i),Ve(this,nt).append(t)}}tt=new WeakMap;nt=new WeakMap;function yo(n,e="inner"){switch(e){case"inner":return We(n);case"anti":return ze(n);case"left":return mo(n);case"right":return vo(n);case"full":return wo(n);default:throw new Error(`Join type ${e} is invalid`)}}function We(n){return e=>{if(e.graph!==n.graph)throw new Error("Cannot join streams from different graphs");const t=new N(e.graph,new D),s=new go(e.graph.getNextOperatorId(),e.connectReader(),n.connectReader(),t.writer);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}function ze(n){return e=>{const t=e.pipe(We(n),b(([r,[i,o]])=>[r,i]));return e.pipe(Ke(t.pipe(io())),b(([r,i])=>[r,[i,null]]))}}function mo(n){return e=>{const t=e,s=n,r=t.pipe(We(s)),i=t.pipe(ze(s));return r.pipe(Ke(i))}}function vo(n){return e=>{const t=e,s=n,r=t.pipe(We(s)),i=s.pipe(ze(t),b(([o,[a,c]])=>[o,[c,a]]));return r.pipe(Ke(i))}}function wo(n){return e=>{const t=e,s=n,r=t.pipe(We(s)),i=t.pipe(ze(s)),o=s.pipe(ze(t),b(([a,[c,l]])=>[a,[l,c]]));return r.pipe(Ke(i),Ke(o))}}var Cs=n=>{throw TypeError(n)},ks=(n,e,t)=>e.has(n)||Cs("Cannot "+t),Ce=(n,e,t)=>(ks(n,e,"read from private field"),t?t.call(n):e.get(n)),Mn=(n,e,t)=>e.has(n)?Cs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Tn=(n,e,t,s)=>(ks(n,e,"write to private field"),e.set(n,t),t),st,ce;class xo extends xe{constructor(e,t,s,r=i=>i){super(e,t,s),Mn(this,st),Mn(this,ce),Tn(this,st,r),Tn(this,ce,new Map)}run(){var e;const t=new Map;for(const r of this.inputMessages())for(const[i,o]of r.getInner()){const a=es(Ce(this,st).call(this,i)),l=(((e=t.get(a))==null?void 0:e[0])??Ce(this,ce).get(a)??0)+o;t.set(a,[l,i])}const s=[];for(const[r,[i,o]]of t.entries()){const a=Ce(this,ce).get(r)??0;i===0?Ce(this,ce).delete(r):Ce(this,ce).set(r,i),a<=0&&i>0?s.push([o,1]):a>0&&i<=0&&s.push([o,-1])}s.length>0&&this.output.sendData(new Q(s))}}st=new WeakMap;ce=new WeakMap;function _o(n=e=>e){return e=>{const t=new N(e.graph,new D),s=new xo(e.graph.getNextOperatorId(),e.connectReader(),t.writer,n);return e.graph.addOperator(s),e.graph.addStream(t.connectReader()),t}}const So="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function me(n,e,t){const s=t[0];if(e!=null&&n>=e)throw new Error(n+" >= "+e);if(n.slice(-1)===s||e&&e.slice(-1)===s)throw new Error("trailing zero");if(e){let o=0;for(;(n[o]||s)===e[o];)o++;if(o>0)return e.slice(0,o)+me(n.slice(o),e.slice(o),t)}const r=n?t.indexOf(n[0]):0,i=e!=null?t.indexOf(e[0]):t.length;if(i-r>1){const o=Math.round(.5*(r+i));return t[o]}else return e&&e.length>1?e.slice(0,1):t[r]+me(n.slice(1),null,t)}function Is(n){if(n.length!==Es(n[0]))throw new Error("invalid integer part of order key: "+n)}function Es(n){if(n>="a"&&n<="z")return n.charCodeAt(0)-97+2;if(n>="A"&&n<="Z")return 90-n.charCodeAt(0)+2;throw new Error("invalid order key head: "+n)}function Ee(n){const e=Es(n[0]);if(e>n.length)throw new Error("invalid order key: "+n);return n.slice(0,e)}function An(n,e){if(n==="A"+e[0].repeat(26))throw new Error("invalid order key: "+n);const t=Ee(n);if(n.slice(t.length).slice(-1)===e[0])throw new Error("invalid order key: "+n)}function Pn(n,e){Is(n);const[t,...s]=n.split("");let r=!0;for(let i=s.length-1;r&&i>=0;i--){const o=e.indexOf(s[i])+1;o===e.length?s[i]=e[0]:(s[i]=e[o],r=!1)}if(r){if(t==="Z")return"a"+e[0];if(t==="z")return null;const i=String.fromCharCode(t.charCodeAt(0)+1);return i>"a"?s.push(e[0]):s.pop(),i+s.join("")}else return t+s.join("")}function Co(n,e){Is(n);const[t,...s]=n.split("");let r=!0;for(let i=s.length-1;r&&i>=0;i--){const o=e.indexOf(s[i])-1;o===-1?s[i]=e.slice(-1):(s[i]=e[o],r=!1)}if(r){if(t==="a")return"Z"+e.slice(-1);if(t==="A")return null;const i=String.fromCharCode(t.charCodeAt(0)-1);return i<"Z"?s.push(e.slice(-1)):s.pop(),i+s.join("")}else return t+s.join("")}function ko(n,e,t=So){if(n!=null&&An(n,t),e!=null&&An(e,t),n!=null&&e!=null&&n>=e)throw new Error(n+" >= "+e);if(n==null){if(e==null)return"a"+t[0];const c=Ee(e),l=e.slice(c.length);if(c==="A"+t[0].repeat(26))return c+me("",l,t);if(c<e)return c;const h=Co(c,t);if(h==null)throw new Error("cannot decrement any more");return h}if(e==null){const c=Ee(n),l=n.slice(c.length),h=Pn(c,t);return h??c+me(l,null,t)}const s=Ee(n),r=n.slice(s.length),i=Ee(e),o=e.slice(i.length);if(s===i)return s+me(r,o,t);const a=Pn(s,t);if(a==null)throw new Error("cannot increment any more");return a<e?a:s+me(r,null,t)}var bs=n=>{throw TypeError(n)},nn=(n,e,t)=>e.has(n)||bs("Cannot "+t),_=(n,e,t)=>(nn(n,e,"read from private field"),t?t.call(n):e.get(n)),te=(n,e,t)=>e.has(n)?bs("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Me=(n,e,t,s)=>(nn(n,e,"write to private field"),e.set(n,t),t),Kn=(n,e,t)=>(nn(n,e,"access private method"),t),R,dt,ee,q,rt,Nt,be,ge,it;class Io{constructor(e,t,s){te(this,rt),te(this,R,[]),te(this,dt),te(this,ee),te(this,q),Me(this,ee,e),Me(this,q,e+t),Me(this,dt,s)}get size(){const e=_(this,ee),t=_(this,q)-_(this,ee),s=_(this,R).length-e;return Math.max(0,Math.min(t,s))}insert(e){const t={moveIn:null,moveOut:null},s=Kn(this,rt,Nt).call(this,e),r=s===0?null:gt(_(this,R)[s-1]),i=s===_(this,R).length?null:gt(_(this,R)[s]),o=ko(r,i),a=Rs(e,o);if(_(this,R).splice(s,0,a),s<_(this,q)){const c=Math.max(s,_(this,ee));c<_(this,R).length&&(t.moveIn=_(this,R)[c],_(this,q)<_(this,R).length&&(t.moveOut=_(this,R)[_(this,q)]))}return t}delete(e){const t={moveIn:null,moveOut:null},s=Kn(this,rt,Nt).call(this,e),[r]=_(this,R).splice(s,1);if(s<_(this,q)){if(t.moveOut=r,s<_(this,ee)){const o=_(this,ee)-1;o<_(this,R).length?t.moveOut=_(this,R)[o]:t.moveOut=null}const i=_(this,q)-1;i<_(this,R).length&&(t.moveIn=_(this,R)[i])}return t}}R=new WeakMap;dt=new WeakMap;ee=new WeakMap;q=new WeakMap;rt=new WeakSet;Nt=function(n){return Ei(_(this,R),Rs(n,""),(e,t)=>_(this,dt).call(this,pt(e),pt(t)))};class Eo extends xe{constructor(e,t,s,r,i){var o;super(e,t,s),te(this,be,new Map),te(this,ge),te(this,it),Me(this,it,i.limit??1/0);const a=i.offset??0,c=(l,h)=>{const u=r(Le(l),Le(h));if(u!==0)return u;const d=Fn(l),f=Fn(h);return d-f};Me(this,ge,this.createTopK(a,_(this,it),c)),(o=i.setSizeCallback)==null||o.call(i,()=>_(this,ge).size)}createTopK(e,t,s){return new Io(e,t,s)}run(){const e=[];for(const t of this.inputMessages())for(const[s,r]of t.getInner()){const[i,o]=s;this.processElement(i,o,r,e)}e.length>0&&this.output.sendData(new Q(e))}processElement(e,t,s,r){const{oldMultiplicity:i,newMultiplicity:o}=this.addKey(e,s);let a={moveIn:null,moveOut:null};if(i<=0&&o>0){const c=zn(e,t);a=_(this,ge).insert(c)}else if(i>0&&o<=0){const c=zn(e,t);a=_(this,ge).delete(c)}if(a.moveIn){const c=gt(a.moveIn),l=pt(a.moveIn),h=$n(l),u=Le(l);r.push([[h,[u,c]],1])}if(a.moveOut){const c=gt(a.moveOut),l=pt(a.moveOut),h=$n(l),u=Le(l);r.push([[h,[u,c]],-1])}}getMultiplicity(e){return _(this,be).get(e)??0}addKey(e,t){const s=this.getMultiplicity(e),r=s+t;return r===0?_(this,be).delete(e):_(this,be).set(e,r),{oldMultiplicity:s,newMultiplicity:r}}}be=new WeakMap;ge=new WeakMap;it=new WeakMap;function bo(n,e){const t=e||{};return s=>{const r=new N(s.graph,new D),i=new Eo(s.graph.getNextOperatorId(),s.connectReader(),r.writer,n,t);return s.graph.addOperator(i),s.graph.addStream(r.connectReader()),r}}function Rs(n,e){return[n,e]}function pt(n){return n[0]}function gt(n){return n[1]}function zn(n,e){return[n,e,je.getId(n)]}function $n(n){return n[0]}function Le(n){return n[1]}function Fn(n){return n[2]}function Ro(n,e,t){const s=t?.limit??1/0,r=t?.offset??0,i=t?.setSizeCallback,o=t?.comparator??((a,c)=>a===c?0:a<c?-1:1);return a=>a.pipe(n((c,l)=>o(e(c),e(l)),{limit:s,offset:r,setSizeCallback:i}),_s())}function Oo(n,e){return Ro(bo,n,e)}const Os=new Set(["eq","gt","lt","gte","lte","and","or","in"]);function Ms(n){const e=n.type;return e==="func"?Os.has(n.name)?n.args.every(t=>Ms(t)):!1:["val","ref"].includes(e)}function Ts(n,e){const t=n.type;if(t==="val")return new jn(n.value);if(t==="ref"){const s=n.path;if(Array.isArray(s)){if(s[0]===e&&s.length>1)return new se(s.slice(1));if(s.length===1&&s[0]!==void 0)return new se([s[0]])}return new se(Array.isArray(s)?s:[String(s)])}else{if(!Os.has(n.name))return null;const s=[];for(const r of n.args){const i=Ts(r,e);if(i==null)return null;s.push(i)}return new wt(n.name,s)}}function Mo(n){const e=To(n);let t=n,s,r=0;const i=10;for(;r<i&&!ue(t,s);)s=t,t=Wt(t),r++;return{optimizedQuery:As(t),collectionWhereClauses:e}}function To(n){const e=new Map;if(!n.where||n.where.length===0)return e;const s=Ps(n.where).map(i=>zs(i)),r=$s(s);for(const[i,o]of r.singleSource)Ao(n,i)&&Ms(o)&&e.set(i,o);return e}function Ao(n,e){if(n.from.alias===e)return n.from.type==="collectionRef";if(n.join){for(const t of n.join)if(t.from.alias===e)return t.from.type==="collectionRef"}return!1}function Wt(n){var e;const t={...n,from:n.from.type==="queryRef"?new L(Wt(n.from.query),n.from.alias):n.from,join:(e=n.join)==null?void 0:e.map(s=>({...s,from:s.from.type==="queryRef"?new L(Wt(s.from.query),s.from.alias):s.from}))};return Po(t)}function Po(n){if(!n.where||n.where.length===0||!n.join||n.join.length===0)return n;const e=n.where.filter(a=>!fn(a)),s=Ps(e).map(a=>zs(a)),r=$s(s),i=zo(n,r),o=n.where.filter(a=>fn(a));return o.length>0&&(i.where=[...i.where||[],...o]),i}function As(n){var e;return{...n,from:Bt(n.from),join:(e=n.join)==null?void 0:e.map(t=>({...t,from:Bt(t.from)}))}}function Bt(n){if(n.type==="collectionRef")return n;const e=As(n.query);if(Ko(e)){const t=Bt(e.from);return t.type==="collectionRef"?new we(t.collection,n.alias):new L(t.query,n.alias)}return new L(e,n.alias)}function Ko(n){return(!n.where||n.where.length===0)&&!n.select&&(!n.groupBy||n.groupBy.length===0)&&(!n.having||n.having.length===0)&&(!n.orderBy||n.orderBy.length===0)&&(!n.join||n.join.length===0)&&n.limit===void 0&&n.offset===void 0&&!n.fnSelect&&(!n.fnWhere||n.fnWhere.length===0)&&(!n.fnHaving||n.fnHaving.length===0)}function Ps(n){const e=[];for(const t of n){const s=Jn(t);e.push(...Ks(s))}return e}function Ks(n){if(n.type==="func"&&n.name==="and"){const e=[];for(const t of n.args)e.push(...Ks(t));return e}else return[n]}function zs(n){const e=new Set;function t(s){switch(s.type){case"ref":if(s.path&&s.path.length>0){const r=s.path[0];r&&e.add(r)}break;case"func":s.args&&s.args.forEach(t);break;case"val":break;case"agg":s.args&&s.args.forEach(t);break}}return t(n),{expression:n,touchedSources:e}}function $s(n){const e=new Map,t=[];for(const i of n)if(i.touchedSources.size===1){const o=Array.from(i.touchedSources)[0];e.has(o)||e.set(o,[]),e.get(o).push(i.expression)}else i.touchedSources.size>1&&t.push(i.expression);const s=new Map;for(const[i,o]of e)s.set(i,Nn(o));const r=t.length>0?Nn(t):void 0;return{singleSource:s,multiSource:r}}function zo(n,e){const t=new Set,s=Dn(n.from,e.singleSource,t),r=n.join?n.join.map(c=>({...c,from:Dn(c.from,e.singleSource,t)})):void 0,i=[];e.multiSource&&i.push(e.multiSource);const o=n.join&&n.join.some(c=>c.type==="left"||c.type==="right"||c.type==="full");for(const[c,l]of e.singleSource)t.has(c)?o&&i.push(Hs(l)):i.push(l);return{select:n.select,groupBy:n.groupBy?[...n.groupBy]:void 0,having:n.having?[...n.having]:void 0,orderBy:n.orderBy?[...n.orderBy]:void 0,limit:n.limit,offset:n.offset,fnSelect:n.fnSelect,fnWhere:n.fnWhere?[...n.fnWhere]:void 0,fnHaving:n.fnHaving?[...n.fnHaving]:void 0,from:s,join:r,where:i.length>0?i:[]}}function Te(n){return{from:n.from.type==="collectionRef"?new we(n.from.collection,n.from.alias):new L(Te(n.from.query),n.from.alias),select:n.select,join:n.join?n.join.map(e=>({type:e.type,left:e.left,right:e.right,from:e.from.type==="collectionRef"?new we(e.from.collection,e.from.alias):new L(Te(e.from.query),e.from.alias)})):void 0,where:n.where?[...n.where]:void 0,groupBy:n.groupBy?[...n.groupBy]:void 0,having:n.having?[...n.having]:void 0,orderBy:n.orderBy?[...n.orderBy]:void 0,limit:n.limit,offset:n.offset,fnSelect:n.fnSelect,fnWhere:n.fnWhere?[...n.fnWhere]:void 0,fnHaving:n.fnHaving?[...n.fnHaving]:void 0}}function Dn(n,e,t){const s=e.get(n.alias);if(!s)return n.type==="collectionRef"?new we(n.collection,n.alias):new L(Te(n.query),n.alias);if(n.type==="collectionRef"){const o={from:new we(n.collection,n.alias),where:[s]};return t.add(n.alias),new L(o,n.alias)}if(!$o(n.query))return new L(Te(n.query),n.alias);const r=n.query.where||[],i={...Te(n.query),where:[...r,s]};return t.add(n.alias),new L(i,n.alias)}function $o(n){return!(n.select&&Object.values(n.select).some(t=>t.type==="agg")||n.groupBy&&n.groupBy.length>0||n.having&&n.having.length>0||n.orderBy&&n.orderBy.length>0&&(n.limit!==void 0||n.offset!==void 0)||n.fnSelect||n.fnWhere&&n.fnWhere.length>0||n.fnHaving&&n.fnHaving.length>0)}function Nn(n){if(n.length===0)throw new Hr;return n.length===1?n[0]:new wt("and",n)}function Fo(n,e,t,s,r,i,o,a,c,l,h,u,d){let f=n;for(const p of e)f=Do(f,p,t,s,r,i,o,a,c,l,h,u,d);return f}function Do(n,e,t,s,r,i,o,a,c,l,h,u,d){const{alias:f,input:p,collectionId:g}=Wo(e.from,i,c,l,h,u,o,a);t[f]=p;const y=c[s],C=c[g];if(!y)throw new wn(s);if(!C)throw new wn(g);const{activeCollection:v,lazyCollection:E}=Vo(e.type,y,C),{mainExpr:S,joinedExpr:m}=No(e.left,e.right,r,f),I=J(S),P=J(m);let K=n.pipe(b(([w,k])=>[I(k),[w,k]])),U=p.pipe(b(([w,k])=>{const A={[f]:k};return[P(A),[w,A]]}));if(!["inner","left","right","full"].includes(e.type))throw new Dr(e.type);if(v){h.add(E.id);const w=v==="main"?K:U;let k;const W=vt(d,v==="main"?m:S,E),G=W.collection,rn=W.path[0];rn&&Qt(rn,W.path,G);let on=!1;const an=w.pipe(Xi(([Fs,da])=>{if(on)return;k??(k=Ne(G.indexes,W.path));const cn=l[E.id];if(!cn)throw new Error("Internal error: callbacks for collection are missing in join pipeline. Make sure the live query collection sets them before running the pipeline.");const{loadKeys:Ds,loadInitialState:Ns}=cn;if(k&&k.supports("eq")){const Ws=k.lookup("eq",Fs);Ds(Ws)}else on=!0,Ns()}));v==="main"?K=an:U=an}return K.pipe(yo(U,e.type),_s(),Bo(e.type))}function No(n,e,t,s){const r=Vt(n),i=Vt(e);if(r===t&&i===s)return{mainExpr:n,joinedExpr:e};if(r===s&&i===t)return{mainExpr:e,joinedExpr:n};throw r===i?new Nr(r||"unknown"):!r||!i?new Wr(t,s):new Br(r,i,t,s)}function Vt(n){switch(n.type){case"ref":return n.path[0]||null;case"func":{const e=new Set;for(const t of n.args){const s=Vt(t);s&&e.add(s)}return e.size===1?Array.from(e)[0]:null}default:return null}}function Wo(n,e,t,s,r,i,o,a){switch(n.type){case"collectionRef":{const c=e[n.collection.id];if(!c)throw new Hn(n.collection.id);return{alias:n.alias,input:c,collectionId:n.collection.id}}case"queryRef":{const c=a.get(n.query)||n.query,l=sn(c,e,t,s,r,i,o,a),u=l.pipeline.pipe(b(d=>{const[f,[p,g]]=d;return[f,p]}));return{alias:n.alias,input:u,collectionId:l.collectionId}}default:throw new Vr(n.type)}}function Bo(n){return function(e){return e.pipe(ne(t=>{const[s,[r,i]]=t,o=r?.[1],a=i?.[1];return n==="inner"?!!(o&&a):n==="left"?!!o:n==="right"?!!a:!0}),b(t=>{const[s,[r,i]]=t,o=r?.[0],a=r?.[1],c=i?.[0],l=i?.[1],h={};return a&&Object.assign(h,a),l&&Object.assign(h,l),[`[${o},${c}]`,h]}))}}function Vo(n,e,t){if(e.id===t.id)return{activeCollection:void 0,lazyCollection:void 0};switch(n){case"left":return{activeCollection:"main",lazyCollection:t};case"right":return{activeCollection:"joined",lazyCollection:e};case"inner":return e.size<t.size?{activeCollection:"main",lazyCollection:t}:{activeCollection:"joined",lazyCollection:e};default:return{activeCollection:void 0,lazyCollection:void 0}}}const{sum:Lo,count:Uo,avg:jo,min:Jo,max:Go}=Hi;function Ho(n,e){const t=new Map,s=[...n];if(!e)return{selectToGroupByIndex:t,groupByExpressions:s};for(const[r,i]of Object.entries(e)){if(i.type==="agg")continue;const o=s.findIndex(a=>yt(i,a));if(o===-1)throw new Lr(r);t.set(r,o)}return{selectToGroupByIndex:t,groupByExpressions:s}}function Wn(n,e,t,s,r){if(e.length===0){const l={};if(s){for(const[u,d]of Object.entries(s))if(d.type==="agg"){const f=d;l[u]=Bn(f)}}const h=()=>({__singleGroup:!0});if(n=n.pipe(Rn(h,l)),n=n.pipe(b(([,u])=>{const f={...u.__select_results||{}};if(s)for(const[p,g]of Object.entries(s))g.type==="agg"&&(f[p]=u[p]);return["single_group",{...u,__select_results:f}]})),t&&t.length>0)for(const u of t){const d=hn(u),f=mt(d,s||{}),p=J(f);n=n.pipe(ne(([,g])=>{const y={result:g.__select_results};return p(y)}))}if(r&&r.length>0)for(const u of r)n=n.pipe(ne(([,d])=>{const f={result:d.__select_results};return u(f)}));return n}const i=Ho(e,s),o=e.map(l=>J(l)),a=([,l])=>{const h={...l};delete h.__select_results;const u={};for(let d=0;d<e.length;d++){const f=o[d],p=f(h);u[`__key_${d}`]=p}return u},c={};if(s){for(const[l,h]of Object.entries(s))if(h.type==="agg"){const u=h;c[l]=Bn(u)}}if(n=n.pipe(Rn(a,c)),n=n.pipe(b(([,l])=>{const h=l.__select_results||{},u={};if(s)for(const[f,p]of Object.entries(s))if(p.type!=="agg"){const g=i.selectToGroupByIndex.get(f);g!==void 0?u[f]=l[`__key_${g}`]:u[f]=h[f]}else u[f]=l[f];else for(let f=0;f<e.length;f++)u[`__key_${f}`]=l[`__key_${f}`];let d;if(e.length===1)d=l.__key_0;else{const f=[];for(let p=0;p<e.length;p++)f.push(l[`__key_${p}`]);d=JSON.stringify(f)}return[d,{...l,__select_results:u}]})),t&&t.length>0)for(const l of t){const h=hn(l),u=mt(h,s||{}),d=J(u);n=n.pipe(ne(([,f])=>{const p={result:f.__select_results};return d(p)}))}if(r&&r.length>0)for(const l of r)n=n.pipe(ne(([,h])=>{const u={result:h.__select_results};return l(u)}));return n}function yt(n,e){var t,s,r,i;if(!n||!e||n.type!==e.type)return!1;switch(n.type){case"ref":return!n.path||!e.path||n.path.length!==e.path.length?!1:n.path.every((o,a)=>o===e.path[a]);case"val":return n.value===e.value;case"func":return n.name===e.name&&((t=n.args)==null?void 0:t.length)===((s=e.args)==null?void 0:s.length)&&(n.args||[]).every((o,a)=>yt(o,e.args[a]));case"agg":return n.name===e.name&&((r=n.args)==null?void 0:r.length)===((i=e.args)==null?void 0:i.length)&&(n.args||[]).every((o,a)=>yt(o,e.args[a]));default:return!1}}function Bn(n){const e=J(n.args[0]),t=([,s])=>{const r=e(s);return typeof r=="number"?r:r!=null?Number(r):0};switch(n.name.toLowerCase()){case"sum":return Lo(t);case"count":return Uo();case"avg":return jo(t);case"min":return Jo(t);case"max":return Go(t);default:throw new Ur(n.name)}}function mt(n,e,t="result"){switch(n.type){case"agg":{const s=n;for(const[r,i]of Object.entries(e))if(i.type==="agg"&&qo(s,i))return new se([t,r]);throw new jr(s.name)}case"func":{const s=n,r=s.args.map(i=>mt(i,e));return new wt(s.name,r)}case"ref":{const s=n;if(s.path.length===1){const r=s.path[0];if(e[r])return new se([t,r])}return n}case"val":return n;default:throw new Jr(n.type)}}function qo(n,e){return n.name===e.name&&n.args.length===e.args.length&&n.args.every((t,s)=>yt(t,e.args[s]))}function Yo(n,e,t,s,r,i,o,a){const c=t.map(d=>{const f=mt(d.expression,s,"__select_results");return{compiledExpression:J(f),compareOptions:d.compareOptions}}),l=d=>{const f={...d};return d.__select_results&&Object.assign(f,d.__select_results),t.length>1?c.map(p=>p.compiledExpression(f)):t.length===1?c[0].compiledExpression(f):null},h=(d,f)=>{if(t.length>1){const p=d,g=f;for(let y=0;y<t.length;y++){const C=t[y],E=Kt(C.compareOptions)(p[y],g[y]);if(E!==0)return E}return p.length-g.length}if(t.length===1){const p=t[0];return Kt(p.compareOptions)(d,f)}return zt(d,f)};let u;if(o&&t.length===1){const f=t[0].expression;if(f.type==="ref"){const p=vt(n,f,r),g=p.collection,y=p.path[0];y&&Qt(y,p.path,g,h);const C=J(new se(p.path),!0),v=(S,m)=>{const I=S&&C(S),P=m&&C(m);return h(I,P)},E=Ne(g.indexes,p.path);if(E&&E.supports("gt")){const S={offset:a??0,limit:o,comparator:v,valueExtractorForRawRow:C,index:E};i[g.id]=S,u=m=>{i[g.id]={...i[g.id],dataNeeded:()=>{const I=m();return Math.max(0,o-I)}}}}}}return e.pipe(Oo(l,{limit:o,offset:a,comparator:h,setSizeCallback:u}))}function Qo(n,e,t){const s=[],r=[];for(const[i,o]of Object.entries(e))if(i.startsWith("__SPREAD_SENTINEL__")){const a=i.replace("__SPREAD_SENTINEL__","");r.push(a)}else Zo(o)?s.push({alias:i,compiledExpression:()=>null}):s.push({alias:i,compiledExpression:J(o)});return n.pipe(b(([i,o])=>{const a={};for(const c of r){const l=o[c];if(l&&typeof l=="object")for(const[h,u]of Object.entries(l))h in a||(a[h]=u)}for(const{alias:c,compiledExpression:l}of s)a[c]=l(o);return[i,{...o,__select_results:a}]}))}function Zo(n){return n.type==="agg"}function sn(n,e,t,s,r,i,o=new WeakMap,a=new WeakMap){const c=o.get(n);if(c)return c;const{optimizedQuery:l,collectionWhereClauses:h}=Mo(n);a.set(l,n),Lt(l,n,a);const u={...e},d={},{alias:f,input:p,collectionId:g}=Xo(l.from,u,t,s,r,i,o,a);d[f]=p;let y=p.pipe(b(([S,m])=>[S,{[f]:m}]));if(l.join&&l.join.length>0&&(y=Fo(y,l.join,d,g,f,u,o,a,t,s,r,i,n)),l.where&&l.where.length>0)for(const S of l.where){const m=Jn(S),I=J(m);y=y.pipe(ne(([P,K])=>I(K)))}if(l.fnWhere&&l.fnWhere.length>0)for(const S of l.fnWhere)y=y.pipe(ne(([m,I])=>S(I)));if(l.distinct&&!l.fnSelect&&!l.select)throw new Tr;if(l.fnSelect?y=y.pipe(b(([S,m])=>{const I=l.fnSelect(m);return[S,{...m,__select_results:I}]})):l.select?y=Qo(y,l.select):y=y.pipe(b(([S,m])=>{const I=!l.join&&!l.groupBy?m[f]:m;return[S,{...m,__select_results:I}]})),l.groupBy&&l.groupBy.length>0?y=Wn(y,l.groupBy,l.having,l.select,l.fnHaving):l.select&&Object.values(l.select).some(m=>m.type==="agg")&&(y=Wn(y,[],l.having,l.select,l.fnHaving)),l.having&&(!l.groupBy||l.groupBy.length===0)&&!(l.select?Object.values(l.select).some(m=>m.type==="agg"):!1))throw new Ar;if(l.fnHaving&&l.fnHaving.length>0&&(!l.groupBy||l.groupBy.length===0))for(const S of l.fnHaving)y=y.pipe(ne(([m,I])=>S(I)));if(l.distinct&&(y=y.pipe(_o(([S,m])=>m.__select_results))),l.orderBy&&l.orderBy.length>0){const I=Yo(n,y,l.orderBy,l.select||{},t[g],i,l.limit,l.offset).pipe(b(([K,[U,w]])=>{const k=U.__select_results;return[K,[k,w]]})),P={collectionId:g,pipeline:I,collectionWhereClauses:h};return o.set(n,P),P}else if(l.limit!==void 0||l.offset!==void 0)throw new Pr;const v=y.pipe(b(([S,m])=>{const I=m.__select_results;return[S,[I,void 0]]})),E={collectionId:g,pipeline:v,collectionWhereClauses:h};return o.set(n,E),E}function Xo(n,e,t,s,r,i,o,a){switch(n.type){case"collectionRef":{const c=e[n.collection.id];if(!c)throw new Hn(n.collection.id);return{alias:n.alias,input:c,collectionId:n.collection.id}}case"queryRef":{const c=a.get(n.query)||n.query,l=sn(c,e,t,s,r,i,o,a),u=l.pipeline.pipe(b(d=>{const[f,[p,g]]=d;return[f,p]}));return{alias:n.alias,input:u,collectionId:l.collectionId}}default:throw new Kr(n.type)}}function Lt(n,e,t){if(n.from.type==="queryRef"&&e.from.type==="queryRef"&&(t.set(n.from.query,e.from.query),Lt(n.from.query,e.from.query,t)),n.join&&e.join)for(let s=0;s<n.join.length&&s<e.join.length;s++){const r=n.join[s],i=e.join[s];r.from.type==="queryRef"&&i.from.type==="queryRef"&&(t.set(r.from.query,i.from.query),Lt(r.from.query,i.from.query,t))}}function ea(n,e){if(n.from.alias===e)return n.from;for(const t of n.join||[])if(t.from.alias===e)return t.from}function vt(n,e,t){if(e.path.length!==0){if(e.path.length===1){const s=e.path[0];if(n.select){const r=n.select[s];if(r&&r.type==="ref")return vt(n,r,t)}return{collection:t,path:[s]}}if(e.path.length>1){const[s,...r]=e.path,i=ea(n,s);return i?i.type==="queryRef"?vt(i.query,new se(r),t):{collection:i.collection,path:r}:void 0}}}class ta{constructor(e,t,s,r,i){this.collectionId=e,this.collection=t,this.config=s,this.syncState=r,this.collectionConfigBuilder=i,this.sentKeys=new Set,this.biggest=void 0,this.sendVisibleChangesToPipeline=(o,a)=>{if(a)return this.sendChangesToPipeline(o);const c=[];for(const l of o){let h=l;if(!this.sentKeys.has(l.key)){if(l.type==="update")h={...l,type:"insert"};else if(l.type==="delete")continue;this.sentKeys.add(l.key)}c.push(h)}return this.sendChangesToPipeline(c)}}subscribe(){const e=na(this.collectionId,this.collectionConfigBuilder.query),t=this.getWhereClauseFromAlias(e);if(t){const s=Ts(t,e);if(s)this.subscribeToChanges(s);else throw new Error(`Failed to convert WHERE clause to collection filter for collection '${this.collectionId}'. This indicates a bug in the query optimization logic.`)}else this.subscribeToChanges()}subscribeToChanges(e){let t;this.collectionConfigBuilder.lazyCollections.has(this.collectionId)?t=this.subscribeToMatchingChanges(e):Object.hasOwn(this.collectionConfigBuilder.optimizableOrderByCollections,this.collectionId)?t=this.subscribeToOrderedChanges(e):t=this.subscribeToAllChanges(e),this.syncState.unsubscribeCallbacks.add(t)}sendChangesToPipeline(e,t){const s=this.syncState.inputs[this.collectionId],i=sa(s,e,this.collection.config.getKey)>0?t:void 0;this.collectionConfigBuilder.maybeRunGraph(this.config,this.syncState,i)}loadKeys(e,t){for(const s of e){if(this.sentKeys.has(s))continue;const r=this.collection.get(s);r!==void 0&&t(r)&&(this.sentKeys.add(s),this.sendChangesToPipeline([{type:"insert",key:s,value:r}]))}}subscribeToAllChanges(e){const t=this.sendChangesToPipeline.bind(this);return this.collection.subscribeChanges(t,{includeInitialState:!0,...e?{whereExpression:e}:void 0})}subscribeToMatchingChanges(e){let t=!1,s=!1;const r=c=>{this.sendVisibleChangesToPipeline(s?c:[],t)},i=this.collection.subscribeChanges(r,{whereExpression:e}),o=e?ct(e):()=>!0,a=c=>(s=!0,this.loadKeys(c,o));return this.collectionConfigBuilder.lazyCollectionsCallbacks[this.collectionId]={loadKeys:a,loadInitialState:()=>{if(t)return;t=!0,s=!0;const c=this.collection.currentStateAsChanges({whereExpression:e});this.sendChangesToPipeline(c)}},i}subscribeToOrderedChanges(e){const{offset:t,limit:s,comparator:r,dataNeeded:i}=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId];this.loadNextItems(t+s);const o=c=>{const l=ra(c);let h=l;i()===0&&(h=oa(l,r,this.biggest)),this.sendChangesToPipeline(h,this.loadMoreIfNeeded.bind(this))};return this.collection.subscribeChanges(o,{whereExpression:e})}loadMoreIfNeeded(){const e=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId];if(!e)return!0;const{dataNeeded:t}=e;if(!t)throw new Error(`Missing dataNeeded callback for collection ${this.collectionId}`);const s=t();let r=!1;return s>0&&(r=this.loadNextItems(s)===0),s===0||r}sendChangesToPipelineWithTracking(e){const{comparator:t}=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId],s=this.trackSentValues(e,t);this.sendChangesToPipeline(s,this.loadMoreIfNeeded.bind(this))}loadNextItems(e){const{valueExtractorForRawRow:t,index:s}=this.collectionConfigBuilder.optimizableOrderByCollections[this.collectionId],r=this.biggest,i=r&&t(r),a=s.take(e,i).map(c=>({type:"insert",key:c,value:this.collection.get(c)}));return this.sendChangesToPipelineWithTracking(a),a.length}getWhereClauseFromAlias(e){const t=this.collectionConfigBuilder.collectionWhereClausesCache;if(e&&t)return t.get(e)}*trackSentValues(e,t){for(const s of e)this.sentKeys.add(s.key),this.biggest?t(this.biggest,s.value)<0&&(this.biggest=s.value):this.biggest=s.value,yield s}}function na(n,e){var t,s,r,i;if(((t=e.from)==null?void 0:t.type)==="collectionRef"&&((s=e.from.collection)==null?void 0:s.id)===n)return e.from.alias;if(e.join){for(const o of e.join)if(((r=o.from)==null?void 0:r.type)==="collectionRef"&&((i=o.from.collection)==null?void 0:i.id)===n)return o.from.alias}}function sa(n,e,t){const s=[];for(const r of e){const i=t(r.value);r.type==="insert"?s.push([[i,r.value],1]):r.type==="update"?(s.push([[i,r.previousValue],-1]),s.push([[i,r.value],1])):s.push([[i,r.value],-1])}return n.sendData(new Q(s)),s.length}function*ra(n){for(const e of n)e.type==="update"?(yield{type:"delete",key:e.key,value:e.previousValue},yield{type:"insert",key:e.key,value:e.value}):yield e}function*ia(n,e){for(const t of n)e(t)&&(yield t)}function*oa(n,e,t){yield*ia(n,s=>!t||e(s.value,t)<=0)}let aa=0;class ca{constructor(e){this.config=e,this.resultKeys=new WeakMap,this.orderByIndices=new WeakMap,this.lazyCollectionsCallbacks={},this.lazyCollections=new Set,this.optimizableOrderByCollections={},this.id=e.id||`live-query-${++aa}`,this.query=la(e),this.collections=ha(this.query),this.query.orderBy&&this.query.orderBy.length>0&&(this.compare=ua(this.orderByIndices)),this.compileBasePipeline()}getConfig(){return{id:this.id,getKey:this.config.getKey||(e=>this.resultKeys.get(e)),sync:this.getSyncConfig(),compare:this.compare,gcTime:this.config.gcTime||5e3,schema:this.config.schema,onInsert:this.config.onInsert,onUpdate:this.config.onUpdate,onDelete:this.config.onDelete,startSync:this.config.startSync}}maybeRunGraph(e,t,s){const{begin:r,commit:i,markReady:o}=e;if(this.allCollectionsReadyOrInitialCommit()&&t.subscribedToAllCollections){t.graph.run();const a=s?.()??!0;t.messagesCount===0&&(r(),i()),a&&this.allCollectionsReady()&&o()}}getSyncConfig(){return{rowUpdateMode:"full",sync:this.syncFn.bind(this)}}syncFn(e){const t={messagesCount:0,subscribedToAllCollections:!1,unsubscribeCallbacks:new Set},s=this.extendPipelineWithChangeProcessing(e,t),r=this.subscribeToAllCollections(e,s);return this.maybeRunGraph(e,s,r),()=>{t.unsubscribeCallbacks.forEach(i=>i()),this.graphCache=void 0,this.inputsCache=void 0,this.pipelineCache=void 0,this.collectionWhereClausesCache=void 0,this.lazyCollections.clear(),this.optimizableOrderByCollections={},this.lazyCollectionsCallbacks={}}}compileBasePipeline(){this.graphCache=new Ai,this.inputsCache=Object.fromEntries(Object.entries(this.collections).map(([s])=>[s,this.graphCache.newInput()]));const{pipeline:e,collectionWhereClauses:t}=sn(this.query,this.inputsCache,this.collections,this.lazyCollectionsCallbacks,this.lazyCollections,this.optimizableOrderByCollections);this.pipelineCache=e,this.collectionWhereClausesCache=t}maybeCompileBasePipeline(){return(!this.graphCache||!this.inputsCache||!this.pipelineCache)&&this.compileBasePipeline(),{graph:this.graphCache,inputs:this.inputsCache,pipeline:this.pipelineCache}}extendPipelineWithChangeProcessing(e,t){const{begin:s,commit:r}=e,{graph:i,inputs:o,pipeline:a}=this.maybeCompileBasePipeline();return a.pipe(ho(c=>{const l=c.getInner();t.messagesCount+=l.length,s(),l.reduce(fa,new Map).forEach(this.applyChanges.bind(this,e)),r()})),i.finalize(),t.graph=i,t.inputs=o,t.pipeline=a,t}applyChanges(e,t,s){const{write:r,collection:i}=e,{deletes:o,inserts:a,value:c,orderByIndex:l}=t;if(this.resultKeys.set(c,s),l!==void 0&&this.orderByIndices.set(c,l),a&&o===0)r({value:c,type:"insert"});else if(a>o||a===o&&i.has(s))r({value:c,type:"update"});else if(o>0)r({value:c,type:"delete"});else throw new Error(`Could not apply changes: ${JSON.stringify(t)}. This should never happen.`)}allCollectionsReady(){return Object.values(this.collections).every(e=>e.isReady())}allCollectionsReadyOrInitialCommit(){return Object.values(this.collections).every(e=>e.status==="ready"||e.status==="initialCommit")}subscribeToAllCollections(e,t){const s=Object.entries(this.collections).map(([i,o])=>{const a=new ta(i,o,e,t,this);return a.subscribe(),a.loadMoreIfNeeded.bind(a)}),r=()=>(s.map(i=>i()),!0);return t.subscribedToAllCollections=!0,r}}function la(n){return typeof n.query=="function"?_i(n.query):Zn(n.query)}function ua(n){return(e,t)=>{const s=n.get(e),r=n.get(t);return s&&r?s<r?-1:s>r?1:0:0}}function ha(n){const e={};function t(r){r.type==="collectionRef"?e[r.collection.id]=r.collection:r.type==="queryRef"&&s(r.query)}function s(r){if(r.from&&t(r.from),r.join&&Array.isArray(r.join))for(const i of r.join)i.from&&t(i.from)}return s(n),e}function fa(n,[[e,t],s]){const[r,i]=t,o=n.get(e)||{deletes:0,inserts:0,value:r,orderByIndex:i};return s<0?o.deletes+=Math.abs(s):s>0&&(o.inserts+=s,o.value=r,o.orderByIndex=i),n.set(e,o),n}function Vn(n){return new ca(n).getConfig()}function Ln(n){if(typeof n=="function"){const t=Vn({query:n});return Un(t)}else{const e=n,t=Vn(e);return Un({...t,utils:e.utils})}}function Un(n){return xi(n)}function ya(n,e=[]){const t=n&&typeof n=="object"&&typeof n.subscribeChanges=="function"&&typeof n.startSyncImmediate=="function"&&typeof n.id=="string",s=j.useRef(null),r=j.useRef(null),i=j.useRef(null),o=!s.current||t&&i.current!==n||!t&&(r.current===null||r.current.length!==e.length||r.current.some((p,g)=>p!==e[g]));o&&(t?(n.startSyncImmediate(),s.current=n,i.current=n):(typeof n=="function"?s.current=Ln({query:n,startSync:!0,gcTime:0}):s.current=Ln({startSync:!0,gcTime:0,...n}),r.current=[...e]));const a=j.useRef(0),c=j.useRef(null);o&&(a.current=0,c.current=null);const l=j.useRef(null);(!l.current||o)&&(l.current=p=>{const g=s.current.subscribeChanges(()=>{a.current+=1,p()});return s.current.status==="ready"&&(a.current+=1,p()),()=>{g()}});const h=j.useRef(null);(!h.current||o)&&(h.current=()=>{const p=a.current,g=s.current;return(!c.current||c.current.version!==p||c.current.collection!==g)&&(c.current={collection:g,version:p}),c.current});const u=j.useSyncExternalStore(l.current,h.current),d=j.useRef(null),f=j.useRef(null);if(!d.current||d.current.version!==u.version||d.current.collection!==u.collection){const p=Array.from(u.collection.entries());let g=null,y=null;f.current={get state(){return g||(g=new Map(p)),g},get data(){return y||(y=p.map(([,C])=>C)),y},collection:u.collection,status:u.collection.status,isLoading:u.collection.status==="loading"||u.collection.status==="initialCommit",isReady:u.collection.status==="ready",isIdle:u.collection.status==="idle",isError:u.collection.status==="error",isCleanedUp:u.collection.status==="cleaned-up"},d.current=u}return f.current}export{F as T,xi as c,ga as e,ya as u};
